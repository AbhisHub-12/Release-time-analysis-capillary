<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Release Duration Analysis Report - Dependency Graph Investigation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #1a5276 0%, #2980b9 100%); color: white; padding: 40px; text-align: center; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header .subtitle { font-size: 1.2em; opacity: 0.9; }
        .header .date { margin-top: 15px; font-size: 0.95em; opacity: 0.8; }
        .section { background: white; border-radius: 10px; padding: 30px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section h2 { color: #1a5276; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.8em; }
        .section h3 { color: #2c3e50; margin: 20px 0 15px 0; font-size: 1.3em; }
        .executive-summary { background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%); border-left: 5px solid #f39c12; }
        .critical-finding { background: #fef2f2; border-left: 5px solid #e74c3c; }
        .chart-container { position: relative; height: 350px; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #1a5276; color: white; font-weight: 600; }
        tr:nth-child(even) { background: #f8f9fa; }
        tr:hover { background: #e8f4f8; }
        .metric-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .metric-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .metric-card.warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .metric-card.danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
        .metric-card .value { font-size: 2.5em; font-weight: bold; margin-bottom: 5px; }
        .metric-card .label { font-size: 0.95em; opacity: 0.9; }
        .priority-tag { display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 0.75em; font-weight: bold; margin-left: 10px; }
        .priority-high { background: #e74c3c; color: white; }
        .priority-medium { background: #f39c12; color: white; }
        .highlight-box { background: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; padding: 15px 20px; margin: 15px 0; }
        .root-cause-item { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .root-cause-item h4 { color: #c0392b; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .icon { width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; background: #e74c3c; color: white; border-radius: 50%; font-size: 14px; }
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 768px) { .two-column { grid-template-columns: 1fr; } }
        .footer { text-align: center; padding: 20px; color: #666; font-size: 0.9em; }
        .code-block { background: #2d3436; color: #dfe6e9; padding: 15px 20px; border-radius: 8px; font-family: 'Courier New', monospace; overflow-x: auto; margin: 10px 0; }
        .dep-chain { background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; margin: 10px 0; border-left: 4px solid #3498db; }
        @media print { .section { break-inside: avoid; } body { background: white; } }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Release Duration Analysis Report</h1>
            <div class="subtitle">Dependency Graph Investigation (Vertices & Edges Analysis)</div>
            <div class="date">Report Generated: December 4, 2025</div>
        </div>

        <!-- Executive Summary -->
        <div class="section executive-summary">
            <h2>Executive Summary</h2>
            <p>This report presents the findings from analyzing the Terraform state file's dependency graph to investigate root causes of increased full release times.</p>

            <div class="metric-cards">
                <div class="metric-card">
                    <div class="value">5,452</div>
                    <div class="label">Vertices (Resources)</div>
                </div>
                <div class="metric-card danger">
                    <div class="value">1.48M</div>
                    <div class="label">Edges (Dependencies)</div>
                </div>
                <div class="metric-card warning">
                    <div class="value">272</div>
                    <div class="label">Avg Edges per Vertex</div>
                </div>
                <div class="metric-card danger">
                    <div class="value">21</div>
                    <div class="label">Critical Path Depth</div>
                </div>
            </div>

            <div class="highlight-box">
                <strong>Key Finding:</strong> The dependency graph shows <strong>1,483,106 edges</strong> connecting 5,452 resources, with an average of 272 dependencies per resource. Major bottleneck resources like <code>base-domain-zone</code> and <code>tooling-vpc</code> block nearly 10,000 downstream resources each.
            </div>
        </div>

        <!-- Dependency Graph Basics -->
        <div class="section">
            <h2>Understanding the Dependency Graph</h2>

            <div class="highlight-box" style="background: #f8f9fa; border-color: #dee2e6;">
                <strong>Graph Theory Basics:</strong>
                <ul style="margin: 10px 0 0 20px;">
                    <li><strong>Vertices (Nodes)</strong> = Resources (helm_release, aws_iam_role, kubernetes_secret, etc.)</li>
                    <li><strong>Edges</strong> = Dependencies between resources (Resource A must complete before Resource B)</li>
                    <li><strong>Critical Path</strong> = Longest chain of dependencies (minimum sequential execution time)</li>
                    <li><strong>Bottleneck</strong> = Resource that blocks many others from starting</li>
                </ul>
            </div>

            <div class="two-column">
                <div>
                    <h3>Graph Statistics</h3>
                    <table>
                        <tr><td>Total Vertices (Resources)</td><td><strong>5,452</strong></td></tr>
                        <tr><td>Total Edges (Dependencies)</td><td><strong>1,483,106</strong></td></tr>
                        <tr><td>Resources WITH dependencies</td><td>4,368</td></tr>
                        <tr><td>Resources WITHOUT dependencies</td><td>1,084</td></tr>
                        <tr><td>Isolated resources</td><td>588</td></tr>
                        <tr><td>Average edges per vertex</td><td>272.03</td></tr>
                    </table>
                </div>
                <div>
                    <h3>Resource Type Distribution</h3>
                    <div class="chart-container">
                        <canvas id="resourceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Critical Path Analysis -->
        <div class="section critical-finding">
            <h2>Root Cause Analysis</h2>

            <div class="root-cause-item">
                <h4><span class="icon">1</span> Critical Path Depth: 21 Resources (CRITICAL)</h4>
                <p>The longest dependency chain requires 21 resources to execute sequentially. This is the <strong>minimum time</strong> required regardless of parallelization.</p>
                <div class="dep-chain">
                    <strong>Critical Path:</strong><br>
                    release_metadata → policy-attach → application-role → app-chart<br>
                    → policy-attach → application-role → example_ingress<br>
                    → cluster-base-domain → nginx_ingress_ctlr → issued-cert<br>
                    → ... (11 more resources)
                </div>
                <p style="margin-top: 10px;"><strong>Impact:</strong> If each resource takes ~30 seconds, this chain alone requires ~10.5 minutes minimum.</p>
            </div>

            <div class="root-cause-item">
                <h4><span class="icon">2</span> Major Bottleneck Resources (CRITICAL)</h4>
                <p>These resources must complete before thousands of others can start:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Resource</th>
                            <th>Type</th>
                            <th>Blocks</th>
                            <th>Impact</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>base-domain-zone</strong></td>
                            <td>data</td>
                            <td>9,872 resources</td>
                            <td><span class="priority-tag priority-high">CRITICAL</span></td>
                        </tr>
                        <tr>
                            <td><strong>tooling-vpc</strong></td>
                            <td>data</td>
                            <td>9,872 resources</td>
                            <td><span class="priority-tag priority-high">CRITICAL</span></td>
                        </tr>
                        <tr>
                            <td><strong>release_metadata</strong></td>
                            <td>scratch_string</td>
                            <td>9,547 resources</td>
                            <td><span class="priority-tag priority-high">CRITICAL</span></td>
                        </tr>
                        <tr>
                            <td>aws_security_group</td>
                            <td>this</td>
                            <td>4,523 resources</td>
                            <td><span class="priority-tag priority-medium">HIGH</span></td>
                        </tr>
                        <tr>
                            <td>aws_rds_cluster</td>
                            <td>this</td>
                            <td>3,688 resources</td>
                            <td><span class="priority-tag priority-medium">HIGH</span></td>
                        </tr>
                        <tr>
                            <td>aws_db_subnet_group</td>
                            <td>this</td>
                            <td>4,515 resources</td>
                            <td><span class="priority-tag priority-medium">HIGH</span></td>
                        </tr>
                    </tbody>
                </table>
                <p style="margin-top: 10px;"><strong>Why this matters:</strong> Any delay in these resources cascades to thousands of downstream resources.</p>
            </div>

            <div class="root-cause-item">
                <h4><span class="icon">3</span> Resources with Excessive Dependencies</h4>
                <p>These resources wait for an extremely high number of other resources to complete:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Resource</th>
                            <th>Waits For</th>
                            <th>Issue</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>example_ingress</strong></td>
                            <td>441,210 resources</td>
                            <td>Excessive fan-in dependency</td>
                        </tr>
                        <tr>
                            <td>mysql_grants</td>
                            <td>107,440 resources</td>
                            <td>Waits for too many resources</td>
                        </tr>
                        <tr>
                            <td>mysql_user</td>
                            <td>107,372 resources</td>
                            <td>Waits for too many resources</td>
                        </tr>
                        <tr>
                            <td>qasuite_cronjob</td>
                            <td>36,363 resources</td>
                            <td>Helm release with huge deps</td>
                        </tr>
                        <tr>
                            <td>cronjob</td>
                            <td>23,715 resources</td>
                            <td>Helm release with huge deps</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="root-cause-item">
                <h4><span class="icon">4</span> Helm Releases with High Dependency Count</h4>
                <p>These Helm releases have unusually high dependency counts, causing delays:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Helm Release</th>
                            <th>Dependencies</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>qasuite_cronjob</td><td>36,363</td></tr>
                        <tr><td>cronjob</td><td>23,715</td></tr>
                        <tr><td>statefulset</td><td>14,229</td></tr>
                        <tr><td>prometheus-mysql-exporters</td><td>4,917</td></tr>
                        <tr><td>mongo-exporters</td><td>3,528</td></tr>
                        <tr><td>bootstrap_jobs</td><td>1,583</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="root-cause-item">
                <h4><span class="icon">5</span> Large Database Fleet Creating Dependency Chains</h4>
                <p>The infrastructure includes numerous database instances that create complex dependency chains:</p>
                <div class="two-column">
                    <div>
                        <h4 style="color: #2c3e50;">MySQL/Aurora Clusters (10)</h4>
                        <ul style="margin-left: 20px;">
                            <li>mysql_airflow</li>
                            <li>mysql_bootorgdb</li>
                            <li>mysql_campaigns</li>
                            <li>mysql_crimson</li>
                            <li>mysql_dbmaster</li>
                            <li>mysql_glue</li>
                            <li>mysql_metadb</li>
                            <li>mysql_nsadmin</li>
                            <li>mysql_reon</li>
                            <li>mysql_solutions</li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="color: #2c3e50;">Redis Sentinel Clusters (15)</h4>
                        <ul style="margin-left: 20px;">
                            <li>api-redis-sentinel</li>
                            <li>apilock-redis-sentinel</li>
                            <li>coupons-redis-sentinel</li>
                            <li>data-redis-sentinel</li>
                            <li>incentives-redis-sentinel</li>
                            <li>loyalty-redis-sentinel</li>
                            <li>nifi-redis-sentinel</li>
                            <li>orchestrator-redis-sentinel</li>
                            <li>+ 7 more clusters</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="section">
            <h2>Recommendations</h2>

            <div class="root-cause-item" style="border-left: 4px solid #e74c3c;">
                <h4 style="color: #e74c3c;">1. Investigate Bottleneck Resource Delays</h4>
                <p>Check why these resources take time during releases:</p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>base-domain-zone</strong> - Is DNS lookup slow?</li>
                    <li><strong>tooling-vpc</strong> - Is VPC data fetch taking time?</li>
                    <li><strong>release_metadata</strong> - Why does this block 9,547 resources?</li>
                </ul>
                <p style="margin-top: 10px;"><strong>Action:</strong> Need release logs to see actual timing for these resources.</p>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #f39c12;">
                <h4 style="color: #f39c12;">2. Review Excessive Dependencies</h4>
                <p>The <code>example_ingress</code> resource waiting for 441,210 resources is abnormal. This could be:</p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>Overly broad <code>depends_on</code> configuration</li>
                    <li>Module-level dependencies pulling in everything</li>
                    <li>Unnecessary implicit dependencies</li>
                </ul>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #3498db;">
                <h4 style="color: #3498db;">3. Split State Files by Domain</h4>
                <p>Breaking down 5,452 resources into smaller states would reduce dependency complexity:</p>
                <div class="code-block">
# Proposed state file structure:
states/
  ├── networking/          # VPC, subnets, security groups
  ├── databases/           # RDS, Redis, MongoDB
  ├── kubernetes-core/     # EKS cluster, base config
  ├── kubernetes-apps/     # Helm releases, deployments
  └── monitoring/          # Prometheus, exporters
                </div>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #27ae60;">
                <h4 style="color: #27ae60;">4. Analyze Release Logs for Timing</h4>
                <p>To identify exact bottlenecks, we need access to:</p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>Terraform apply logs showing per-resource timing</li>
                    <li>CI/CD pipeline logs (Jenkins/GitLab)</li>
                    <li>Facets control plane release logs</li>
                </ul>
            </div>
        </div>

        <!-- Next Steps -->
        <div class="section">
            <h2>Next Steps: Log Analysis Required</h2>

            <div class="highlight-box" style="background: #fff3cd; border-color: #ffc107;">
                <strong>Important:</strong> The Terraform state file shows the dependency structure but does NOT contain execution timing logs. To understand WHY specific resources take time, we need access to release logs.
            </div>

            <h3>Logs Needed for Further Investigation</h3>
            <table>
                <thead>
                    <tr>
                        <th>Log Type</th>
                        <th>What It Shows</th>
                        <th>Where to Find</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Terraform Apply Logs</td>
                        <td>Time taken per resource</td>
                        <td>CI/CD pipeline output</td>
                    </tr>
                    <tr>
                        <td>Helm Release Logs</td>
                        <td>Pod startup times, errors</td>
                        <td>kubectl logs, Kubernetes events</td>
                    </tr>
                    <tr>
                        <td>AWS CloudTrail</td>
                        <td>API call latencies</td>
                        <td>AWS Console</td>
                    </tr>
                    <tr>
                        <td>Facets Release Logs</td>
                        <td>Full release timing breakdown</td>
                        <td>Facets Control Plane</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Reference Section -->
        <div class="section" style="background: #f8f9fa;">
            <h2>Reference: Observed Release Duration Trends</h2>
            <p style="color: #666; margin-bottom: 20px;"><em>The following graphs show the observed increase in release duration times that prompted this investigation.</em></p>

            <h3>Non-Production Environment Trends</h3>
            <div class="highlight-box" style="background: #fff; border-color: #dee2e6; margin-bottom: 15px;">
                <strong>Environment Legend:</strong>
                <ul style="margin: 10px 0 0 20px; list-style: disc;">
                    <li><strong>D-FR</strong> = Development Full Release</li>
                    <li><strong>N-FR</strong> = Nightly Full Release</li>
                    <li><strong>S-FR</strong> = Staging Full Release</li>
                </ul>
            </div>
            <div class="chart-container" style="height: 350px;">
                <canvas id="nonProdChart"></canvas>
            </div>

            <h3 style="margin-top: 30px;">Production Environment Trends</h3>
            <div class="chart-container" style="height: 400px;">
                <canvas id="prodChart"></canvas>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Report Generated by Infrastructure Analysis System</p>
            <p>For questions or clarifications, please contact the Facets DevOps/SRE Team</p>
        </div>
    </div>

    <script>
        // Resource Distribution Chart
        const resourceCtx = document.getElementById('resourceChart').getContext('2d');
        new Chart(resourceCtx, {
            type: 'doughnut',
            data: {
                labels: ['helm_release', 'scratch_string', 'tekton_action', 'random_password', 'k8s_secret', 'aws_iam_role', 'Other'],
                datasets: [{
                    data: [1228, 1478, 651, 464, 332, 249, 1050],
                    backgroundColor: ['#e74c3c', '#3498db', '#9b59b6', '#f39c12', '#1abc9c', '#e67e22', '#95a5a6']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Resource Types (5,452 total)' },
                    legend: { position: 'bottom', labels: { boxWidth: 12 } }
                }
            }
        });

        // Non-Production Chart
        const nonProdCtx = document.getElementById('nonProdChart').getContext('2d');
        new Chart(nonProdCtx, {
            type: 'line',
            data: {
                labels: ['17-23 Sept', '24-30 Sept', '1-7 Oct', '8-15 Oct'],
                datasets: [{
                    label: 'D-FR (Development)',
                    data: [9.95, 10.18, 10.87, 11.22],
                    borderColor: '#27ae60',
                    tension: 0.4,
                    borderWidth: 3
                }, {
                    label: 'N-FR (Nightly)',
                    data: [13.235, 14.67, 15.665, 16.62],
                    borderColor: '#2980b9',
                    tension: 0.4,
                    borderWidth: 3
                }, {
                    label: 'S-FR (Staging)',
                    data: [null, 13.905, null, 16.06],
                    borderColor: '#1a5276',
                    tension: 0.4,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Non-Production Full Release Duration (Minutes)' },
                    legend: { position: 'top' }
                },
                scales: { y: { beginAtZero: true, max: 20 } }
            }
        });

        // Production Chart
        const prodCtx = document.getElementById('prodChart').getContext('2d');
        new Chart(prodCtx, {
            type: 'line',
            data: {
                labels: ['17-23 Sept', '24-30 Sept', '1-7 Oct', '8-15 Oct'],
                datasets: [
                    { label: 'EU-FR', data: [27, 27.5, 27.5, 27], borderColor: '#1a5276', tension: 0.4, borderWidth: 2 },
                    { label: 'Asia-FR', data: [22, 16, 16, 16], borderColor: '#27ae60', tension: 0.4, borderWidth: 2 },
                    { label: 'USHC-FR', data: [17, 0, 15.5, 21], borderColor: '#2980b9', tension: 0.4, borderWidth: 2 },
                    { label: 'SEACRM-FR', data: [12, 14, 15, 17], borderColor: '#16a085', tension: 0.4, borderWidth: 2 },
                    { label: 'I-FR', data: [10, 12, 15, 15], borderColor: '#8e44ad', tension: 0.4, borderWidth: 2 },
                    { label: 'Tata-FR', data: [11, 12, 13, 14], borderColor: '#e67e22', tension: 0.4, borderWidth: 2 },
                    { label: 'SGFR', data: [6.5, 7, 7, 7], borderColor: '#e91e63', tension: 0.4, borderWidth: 2 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Production Full Release Duration (Minutes)' },
                    legend: { position: 'right' }
                },
                scales: { y: { beginAtZero: true, max: 30 } }
            }
        });
    </script>
</body>
</html>
