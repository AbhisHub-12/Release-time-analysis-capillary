<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Release Duration Analysis Report - Removable Dependencies Investigation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #1a5276 0%, #2980b9 100%); color: white; padding: 40px; text-align: center; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header .subtitle { font-size: 1.2em; opacity: 0.9; }
        .header .date { margin-top: 15px; font-size: 0.95em; opacity: 0.8; }
        .section { background: white; border-radius: 10px; padding: 30px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section h2 { color: #1a5276; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.8em; }
        .section h3 { color: #2c3e50; margin: 20px 0 15px 0; font-size: 1.3em; }
        .executive-summary { background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%); border-left: 5px solid #f39c12; }
        .critical-finding { background: #fef2f2; border-left: 5px solid #e74c3c; }
        .actionable { background: #e8f5e9; border-left: 5px solid #27ae60; }
        .chart-container { position: relative; height: 350px; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #1a5276; color: white; font-weight: 600; }
        tr:nth-child(even) { background: #f8f9fa; }
        tr:hover { background: #e8f4f8; }
        .metric-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .metric-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .metric-card.warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .metric-card.danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
        .metric-card.success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .metric-card .value { font-size: 2.5em; font-weight: bold; margin-bottom: 5px; }
        .metric-card .label { font-size: 0.95em; opacity: 0.9; }
        .priority-tag { display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 0.75em; font-weight: bold; margin-left: 10px; }
        .priority-high { background: #e74c3c; color: white; }
        .priority-medium { background: #f39c12; color: white; }
        .priority-low { background: #27ae60; color: white; }
        .highlight-box { background: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; padding: 15px 20px; margin: 15px 0; }
        .warning-box { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px 20px; margin: 15px 0; }
        .success-box { background: #d4edda; border: 1px solid #28a745; border-radius: 8px; padding: 15px 20px; margin: 15px 0; }
        .root-cause-item { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .root-cause-item h4 { color: #c0392b; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .icon { width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; background: #e74c3c; color: white; border-radius: 50%; font-size: 14px; }
        .icon.green { background: #27ae60; }
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 768px) { .two-column { grid-template-columns: 1fr; } }
        .footer { text-align: center; padding: 20px; color: #666; font-size: 0.9em; }
        .code-block { background: #2d3436; color: #dfe6e9; padding: 15px 20px; border-radius: 8px; font-family: 'Courier New', monospace; overflow-x: auto; margin: 10px 0; font-size: 0.9em; }
        .dep-chain { background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; margin: 10px 0; border-left: 4px solid #3498db; font-size: 0.85em; }
        .action-item { background: #e8f5e9; border-left: 4px solid #27ae60; padding: 15px; margin: 10px 0; border-radius: 0 8px 8px 0; }
        .action-item h5 { color: #27ae60; margin-bottom: 8px; }
        .full-width-section { background: white; padding: 40px 0; margin: 0 -20px 25px -20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .full-width-section .section-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .full-width-section h2 { color: #1a5276; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.8em; }
        .full-width-chart { height: 450px; margin: 30px 0; }
        @media print { .section { break-inside: avoid; } body { background: white; } }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Release Duration Analysis Report</h1>
            <div class="subtitle">Removable Dependencies Investigation - Terraform State Analysis</div>
            <div class="date">Report Generated: December 9, 2025 | Version 3.0 - Final Validated</div>
        </div>

        <!-- Executive Summary -->
        <div class="section executive-summary">
            <h2>Executive Summary</h2>
            <p>This report presents a comprehensive analysis of the Terraform state file dependency graph to identify optimization opportunities for reducing release duration. The investigation focuses on module-level dependencies, resource type relationships, and critical bottlenecks affecting deployment performance.</p>

            <div class="metric-cards">
                <div class="metric-card">
                    <div class="value">5,452</div>
                    <div class="label">Total Resources (Vertices)</div>
                </div>
                <div class="metric-card danger">
                    <div class="value">1.48M</div>
                    <div class="label">Dependency Edges</div>
                </div>
                <div class="metric-card warning">
                    <div class="value">441K</div>
                    <div class="label">Max Fan-In (example_ingress)</div>
                </div>
                <div class="metric-card success">
                    <div class="value">5</div>
                    <div class="label">Key Optimizations Found</div>
                </div>
            </div>

            <div class="success-box">
                <strong>Key Finding:</strong> Analysis reveals that certain resources, such as <code>example_ingress</code>, exhibit <strong>441,210 dependency edges</strong>, significantly exceeding expected patterns. This indicates potential optimization opportunities in the <code>depends_on</code> configurations within the Terraform modules.
            </div>
        </div>

        <!-- Understanding Dependencies -->
        <div class="section">
            <h2>Understanding Dependency Analysis</h2>

            <div class="warning-box">
                <strong>Important Clarification: Edges vs Resources</strong>
                <p style="margin-top: 10px;">The "blocks X resources" count represents <strong>dependency edges</strong>, not unique resources. When a resource like <code>base-domain-zone</code> shows "blocks 9,872" it means:</p>
                <ul style="margin: 10px 0 0 20px;">
                    <li>There are 9,872 <strong>dependency connections</strong> pointing to this resource</li>
                    <li>Multiple resources may have multiple edges to the same bottleneck</li>
                    <li>Total unique resources in state: <strong>5,452</strong></li>
                    <li>Total dependency edges: <strong>1,483,106</strong></li>
                </ul>
            </div>

            <div class="highlight-box">
                <strong>Fan-In vs Fan-Out:</strong>
                <ul style="margin: 10px 0 0 20px;">
                    <li><strong>Fan-In (Excessive Dependencies)</strong> = Resource waits for too many others before it can start</li>
                    <li><strong>Fan-Out (Bottleneck)</strong> = Resource blocks too many others from starting</li>
                    <li><strong>Goal:</strong> Reduce unnecessary dependencies to allow more parallelization</li>
                </ul>
            </div>

            <div class="two-column">
                <div>
                    <h3>Graph Statistics</h3>
                    <table>
                        <tr><td>Total Vertices (Resources)</td><td><strong>5,452</strong></td></tr>
                        <tr><td>Total Edges (Dependencies)</td><td><strong>1,483,106</strong></td></tr>
                        <tr><td>Resources WITH dependencies</td><td>4,368</td></tr>
                        <tr><td>Resources WITHOUT dependencies</td><td>1,084</td></tr>
                        <tr><td>Average edges per vertex</td><td>272.03</td></tr>
                        <tr><td>Critical Path Depth</td><td>21 resources</td></tr>
                    </table>
                </div>
                <div>
                    <h3>Resource Type Distribution</h3>
                    <div class="chart-container">
                        <canvas id="resourceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Facets Resource Type Distribution -->
        <div class="section">
            <h2>Facets Resource Type Distribution</h2>
            <p style="color: #666; margin-bottom: 20px;">
                This chart shows how many instances exist for each Facets resource type in the environment.
                <strong>Facets resource types</strong> are high-level abstractions (like "service", "mysql", "ingress") that create multiple Terraform resources.
            </p>

            <div class="chart-container" style="height: 450px;">
                <canvas id="facetsTypeChart"></canvas>
            </div>

            <div class="highlight-box" style="margin-top: 20px;">
                <strong>Key Findings:</strong>
                <ul style="margin: 10px 0 0 20px;">
                    <li><strong>k8s</strong> (514 instances) - Kubernetes resources like clusters, roles, etc.</li>
                    <li><strong>mysql</strong> (247 instances) - MySQL databases with 1,687 Terraform resources</li>
                    <li><strong>service</strong> (222 instances) - Application services (✅ already excluded from outputs)</li>
                    <li><strong>grafana</strong> (107 instances) - Monitoring dashboards</li>
                    <li><strong>Total:</strong> 33 different Facets resource types found in state file</li>
                </ul>
            </div>
        </div>

        <!-- CRITICAL: Module-Level Dependency Analysis - TOP SECTION -->
        <div class="section critical-finding">
            <h2>Critical: Module-Level Dependency Analysis</h2>

            <div class="warning-box" style="background: #fef2f2; border-color: #e74c3c;">
                <strong style="color: #e74c3c;">CRITICAL FINDING:</strong> <code>module.level2.module.ingress_intouch-a</code> has <strong>444,602 dependencies</strong> with only 10 resources. This is abnormal - an ingress module should only depend on nginx controller and certificate (~50-100 deps).
            </div>

            <h3>Top 10 Modules by Dependency Count (Fan-In)</h3>
            <p>These modules wait for the most dependencies before they can execute:</p>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Module</th>
                        <th>Resources</th>
                        <th>Dependencies</th>
                        <th>Avg/Resource</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: #fef2f2;">
                        <td>1</td>
                        <td><strong>module.application</strong></td>
                        <td>15</td>
                        <td style="color: #e74c3c;"><strong>577,871</strong></td>
                        <td>38,525</td>
                        <td><span class="priority-tag priority-high">CRITICAL</span></td>
                    </tr>
                    <tr style="background: #fef2f2;">
                        <td>2</td>
                        <td><strong>module.level2.module.ingress_intouch-a</strong></td>
                        <td>10</td>
                        <td style="color: #e74c3c;"><strong>444,602</strong></td>
                        <td>44,460</td>
                        <td><span class="priority-tag priority-high">CRITICAL</span></td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>module.iam.module.application_roles</td>
                        <td>4</td>
                        <td>44,280</td>
                        <td>11,070</td>
                        <td><span class="priority-tag priority-medium">HIGH</span></td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>module.mysql_dbmaster.sharded_mysql_schema_seed</td>
                        <td>3</td>
                        <td>25,548</td>
                        <td>8,516</td>
                        <td><span class="priority-tag priority-medium">HIGH</span></td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td>module.mysql_dbmaster.mysql_schema_seed</td>
                        <td>3</td>
                        <td>22,364</td>
                        <td>7,455</td>
                        <td><span class="priority-tag priority-medium">HIGH</span></td>
                    </tr>
                    <tr>
                        <td>6</td>
                        <td>module.mysql_reon.mysql_schema_seed</td>
                        <td>2</td>
                        <td>22,272</td>
                        <td>11,136</td>
                        <td><span class="priority-tag priority-medium">HIGH</span></td>
                    </tr>
                    <tr>
                        <td>7</td>
                        <td>module.mysql_metadb.mysql_schema_seed</td>
                        <td>2</td>
                        <td>9,607</td>
                        <td>4,804</td>
                        <td><span class="priority-tag priority-medium">HIGH</span></td>
                    </tr>
                    <tr>
                        <td>8</td>
                        <td>module.level2.module.service_internal-intouch-api-a</td>
                        <td>6</td>
                        <td>5,642</td>
                        <td>940</td>
                        <td><span class="priority-tag priority-medium">REVIEW</span></td>
                    </tr>
                    <tr>
                        <td>9</td>
                        <td>module.level2.module.service_intouch-api-read-a</td>
                        <td>6</td>
                        <td>5,642</td>
                        <td>940</td>
                        <td><span class="priority-tag priority-medium">REVIEW</span></td>
                    </tr>
                    <tr>
                        <td>10</td>
                        <td>module.level2.module.service_async-a</td>
                        <td>6</td>
                        <td>5,372</td>
                        <td>895</td>
                        <td><span class="priority-tag priority-medium">REVIEW</span></td>
                    </tr>
                </tbody>
            </table>

            <h3>Dependency Breakdown: Top 10 Modules</h3>
            <div class="highlight-box" style="margin-bottom: 20px;">
                <strong>Understanding the Analysis Below:</strong>
                <p style="margin-top: 10px;">Each module below shows where its dependencies come from. <code>module.level2</code> contains ~5,000 resources (all services, ingress, IAM roles, etc.). When a module depends on 90-99% from "module.level2", it means it's waiting for most/all of those 5,000 resources to complete.</p>
            </div>

            <h4>1. module.application (577,871 dependencies)</h4>
            <div class="two-column">
                <div>
                    <h5>By Module Path (Where dependencies come from)</h5>
                    <table>
                        <thead>
                            <tr><th>Source Module Path</th><th>Dependencies</th><th>%</th></tr>
                        </thead>
                        <tbody>
                            <tr style="background: #fef2f2;">
                                <td><strong>module.level2.*</strong></td>
                                <td style="color: #e74c3c;"><strong>576,450</strong></td>
                                <td>99.8%</td>
                            </tr>
                            <tr><td>root</td><td>732</td><td>0.1%</td></tr>
                            <tr><td>application</td><td>626</td><td>0.1%</td></tr>
                        </tbody>
                    </table>
                    <div class="warning-box" style="margin-top: 10px;">
                        <strong>Finding:</strong> 99.8% of dependencies are from resources inside <code>module.level2</code> (all the services, ingress, etc.)
                    </div>
                </div>
                <div>
                    <h5>By Resource Type</h5>
                    <table>
                        <thead>
                            <tr><th>Resource Type</th><th>Instances</th><th>Note</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>service</td><td>222</td><td>✅ Already excluded</td></tr>
                            <tr><td>mysql</td><td>247</td><td>⚠️ mysql_user excluded</td></tr>
                            <tr><td>k8s</td><td>514</td><td>Infrastructure</td></tr>
                            <tr><td>ingress</td><td>5</td><td>❌ Must keep (routing)</td></tr>
                            <tr><td>iam</td><td>10</td><td>✅ Add to exclusion</td></tr>
                        </tbody>
                    </table>
                    <div class="warning-box" style="margin-top: 10px; font-size: 0.9em;">
                        <strong>Note:</strong> This module contains helm_release, mysql resources, etc. (Terraform types). Above shows corresponding Facets types.
                    </div>
                </div>
            </div>

            <h4>2. module.level2.module.ingress_intouch-a (444,602 dependencies)</h4>
            <div class="two-column">
                <div>
                    <h5>By Module Path (Where dependencies come from)</h5>
                    <table>
                        <thead>
                            <tr><th>Source Module Path</th><th>Dependencies</th><th>%</th></tr>
                        </thead>
                        <tbody>
                            <tr style="background: #fef2f2;">
                                <td><strong>module.level2.*</strong></td>
                                <td style="color: #e74c3c;"><strong>442,274</strong></td>
                                <td>99.5%</td>
                            </tr>
                            <tr><td>root</td><td>1,892</td><td>0.4%</td></tr>
                            <tr><td>iam</td><td>436</td><td>0.1%</td></tr>
                        </tbody>
                    </table>
                    <div class="warning-box" style="margin-top: 10px;">
                        <strong>Finding:</strong> An ingress should only depend on nginx + cert (~50-100 deps), but this depends on 99.5% of all resources in module.level2
                    </div>
                </div>
                <div>
                    <h5>By Resource Type</h5>
                    <table>
                        <thead>
                            <tr><th>Resource Type</th><th>Instances</th><th>Note</th></tr>
                        </thead>
                        <tbody>
                            <tr style="background: #fef2f2;"><td><strong>ingress</strong></td><td>5</td><td>❌ MUST KEEP (critical)</td></tr>
                            <tr><td>service</td><td>222</td><td>✅ Already excluded</td></tr>
                            <tr><td>k8s</td><td>514</td><td>Infrastructure deps</td></tr>
                            <tr><td>cert</td><td>1</td><td>Certificate manager</td></tr>
                        </tbody>
                    </table>
                    <div class="warning-box" style="margin-top: 10px; font-size: 0.9em;">
                        <strong>Critical:</strong> <code>ingress</code> cannot be excluded - it's needed for routing traffic to services, despite the 444K dependencies.
                    </div>
                </div>
            </div>

            <h4>3. module.iam.module.application_roles (44,280 dependencies)</h4>
            <div class="two-column">
                <div>
                    <h5>By Module Path</h5>
                    <table>
                        <thead>
                            <tr><th>Source Module Path</th><th>Dependencies</th><th>%</th></tr>
                        </thead>
                        <tbody>
                            <tr style="background: #fef2f2;">
                                <td><strong>module.level2.*</strong></td>
                                <td style="color: #e74c3c;"><strong>44,100</strong></td>
                                <td>99.6%</td>
                            </tr>
                            <tr><td>root</td><td>156</td><td>0.4%</td></tr>
                        </tbody>
                    </table>
                    <div class="warning-box" style="margin-top: 10px;">
                        <strong>Finding:</strong> IAM roles should not wait for application deployments
                    </div>
                </div>
                <div>
                    <h5>By Resource Type</h5>
                    <table>
                        <thead>
                            <tr><th>Resource Type</th><th>Instances</th><th>Action</th></tr>
                        </thead>
                        <tbody>
                            <tr style="background: #d4edda;"><td><strong>iam</strong></td><td>10</td><td>✅ ADD to exclusion</td></tr>
                            <tr><td>service</td><td>222</td><td>✅ Already excluded</td></tr>
                            <tr><td>k8s</td><td>514</td><td>Infrastructure</td></tr>
                        </tbody>
                    </table>
                    <div class="success-box" style="margin-top: 10px; font-size: 0.9em;">
                        <strong>Recommendation:</strong> Add <code>iam</code> to exclusion list. IAM policies don't need to be in module outputs.
                    </div>
                </div>
            </div>

            <h4>4. module.mysql_dbmaster.sharded_mysql_schema_seed (25,548 dependencies)</h4>
            <div class="two-column">
                <div>
                    <h5>By Module Path</h5>
                    <table>
                        <thead>
                            <tr><th>Source Module Path</th><th>Dependencies</th><th>%</th></tr>
                        </thead>
                        <tbody>
                            <tr style="background: #fef2f2;">
                                <td><strong>module.level2.*</strong></td>
                                <td style="color: #e74c3c;"><strong>23,956</strong></td>
                                <td>93.8%</td>
                            </tr>
                            <tr><td>mysql_dbmaster</td><td>1,284</td><td>5.0%</td></tr>
                            <tr><td>root</td><td>308</td><td>1.2%</td></tr>
                        </tbody>
                    </table>
                    <div class="warning-box" style="margin-top: 10px; font-size: 0.9em;">
                        <strong>Finding:</strong> MySQL schema should only wait for MySQL instance, not all 5,000 resources
                    </div>
                </div>
                <div>
                    <h5>By Resource Type</h5>
                    <table>
                        <thead>
                            <tr><th>Resource Type</th><th>Instances</th><th>Note</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>mysql</td><td>247</td><td>MySQL databases</td></tr>
                            <tr><td>service</td><td>222</td><td>✅ Already excluded</td></tr>
                            <tr><td>k8s</td><td>514</td><td>Infrastructure</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <h4>5. module.mysql_dbmaster.mysql_schema_seed (22,364 dependencies)</h4>
            <div class="two-column">
                <div>
                    <h5>By Module Path</h5>
                    <table>
                        <thead>
                            <tr><th>Source Module Path</th><th>Dependencies</th><th>%</th></tr>
                        </thead>
                        <tbody>
                            <tr style="background: #fef2f2;">
                                <td><strong>module.level2.*</strong></td>
                                <td style="color: #e74c3c;"><strong>20,772</strong></td>
                                <td>92.9%</td>
                            </tr>
                            <tr><td>mysql_dbmaster</td><td>1,284</td><td>5.7%</td></tr>
                        </tbody>
                    </table>
                </div>
                <div>
                    <h5>By Resource Type</h5>
                    <table>
                        <thead>
                            <tr><th>Resource Type</th><th>Instances</th><th>Note</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>mysql</td><td>247</td><td>MySQL databases</td></tr>
                            <tr><td>service</td><td>222</td><td>✅ Already excluded</td></tr>
                            <tr><td>k8s</td><td>514</td><td>Infrastructure</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <h4>6. module.mysql_reon.mysql_schema_seed (22,272 dependencies)</h4>
            <div class="two-column">
                <div>
                    <h5>By Module Path</h5>
                    <table>
                        <thead>
                            <tr><th>Source Module Path</th><th>Dependencies</th><th>%</th></tr>
                        </thead>
                        <tbody>
                            <tr style="background: #fef2f2;">
                                <td><strong>module.level2.*</strong></td>
                                <td style="color: #e74c3c;"><strong>20,680</strong></td>
                                <td>92.8%</td>
                            </tr>
                            <tr><td>mysql_reon</td><td>1,284</td><td>5.8%</td></tr>
                        </tbody>
                    </table>
                </div>
                <div>
                    <h5>By Resource Type</h5>
                    <table>
                        <thead>
                            <tr><th>Resource Type</th><th>Instances</th><th>Note</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>mysql</td><td>247</td><td>MySQL databases</td></tr>
                            <tr><td>service</td><td>222</td><td>✅ Already excluded</td></tr>
                            <tr><td>k8s</td><td>514</td><td>Infrastructure</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <h4>7. module.mysql_metadb.mysql_schema_seed (9,607 dependencies)</h4>
            <div class="two-column">
                <div>
                    <h5>By Module Path</h5>
                    <table>
                        <thead>
                            <tr><th>Source Module Path</th><th>Dependencies</th><th>%</th></tr>
                        </thead>
                        <tbody>
                            <tr style="background: #fef2f2;">
                                <td><strong>module.level2.*</strong></td>
                                <td style="color: #e74c3c;"><strong>8,923</strong></td>
                                <td>92.9%</td>
                            </tr>
                            <tr><td>mysql_metadb</td><td>548</td><td>5.7%</td></tr>
                        </tbody>
                    </table>
                </div>
                <div>
                    <h5>By Resource Type</h5>
                    <table>
                        <thead>
                            <tr><th>Resource Type</th><th>Instances</th><th>Note</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>mysql</td><td>247</td><td>MySQL databases</td></tr>
                            <tr><td>service</td><td>222</td><td>✅ Already excluded</td></tr>
                            <tr><td>k8s</td><td>514</td><td>Infrastructure</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <h4>8. module.level2.module.service_internal-intouch-api-a (5,642 dependencies)</h4>
            <div class="two-column">
                <div>
                    <h5>By Module Path</h5>
                    <table>
                        <thead>
                            <tr><th>Source Module Path</th><th>Dependencies</th><th>%</th></tr>
                        </thead>
                        <tbody>
                            <tr style="background: #fef2f2;">
                                <td><strong>module.level2.*</strong></td>
                                <td style="color: #e74c3c;"><strong>5,124</strong></td>
                                <td>90.8%</td>
                            </tr>
                            <tr><td>root</td><td>412</td><td>7.3%</td></tr>
                            <tr><td>iam</td><td>106</td><td>1.9%</td></tr>
                        </tbody>
                    </table>
                    <div class="warning-box" style="margin-top: 10px; font-size: 0.9em;">
                        <strong>Finding:</strong> Service modules show 90.8% pattern - template-level issue
                    </div>
                </div>
                <div>
                    <h5>By Resource Type</h5>
                    <table>
                        <thead>
                            <tr><th>Resource Type</th><th>Instances</th><th>Note</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>service</td><td>222</td><td>✅ Already excluded</td></tr>
                            <tr><td>k8s</td><td>514</td><td>Infrastructure</td></tr>
                            <tr><td>iam</td><td>10</td><td>✅ Add to exclusion</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <h4>9. module.level2.module.service_intouch-api-read-a (5,642 dependencies)</h4>
            <div class="two-column">
                <div>
                    <h5>By Module Path</h5>
                    <table>
                        <thead>
                            <tr><th>Source Module Path</th><th>Dependencies</th><th>%</th></tr>
                        </thead>
                        <tbody>
                            <tr style="background: #fef2f2;">
                                <td><strong>module.level2.*</strong></td>
                                <td style="color: #e74c3c;"><strong>5,124</strong></td>
                                <td>90.8%</td>
                            </tr>
                            <tr><td>root</td><td>412</td><td>7.3%</td></tr>
                        </tbody>
                    </table>
                </div>
                <div>
                    <h5>By Resource Type</h5>
                    <table>
                        <thead>
                            <tr><th>Resource Type</th><th>Instances</th><th>Note</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>service</td><td>222</td><td>✅ Already excluded</td></tr>
                            <tr><td>k8s</td><td>514</td><td>Infrastructure</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <h4>10. module.level2.module.service_async-a (5,372 dependencies)</h4>
            <div class="two-column">
                <div>
                    <h5>By Module Path</h5>
                    <table>
                        <thead>
                            <tr><th>Source Module Path</th><th>Dependencies</th><th>%</th></tr>
                        </thead>
                        <tbody>
                            <tr style="background: #fef2f2;">
                                <td><strong>module.level2.*</strong></td>
                                <td style="color: #e74c3c;"><strong>4,878</strong></td>
                                <td>90.8%</td>
                            </tr>
                            <tr><td>root</td><td>392</td><td>7.3%</td></tr>
                        </tbody>
                    </table>
                </div>
                <div>
                    <h5>By Resource Type</h5>
                    <table>
                        <thead>
                            <tr><th>Resource Type</th><th>Instances</th><th>Note</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>service</td><td>222</td><td>✅ Already excluded</td></tr>
                            <tr><td>k8s</td><td>514</td><td>Infrastructure</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="success-box" style="margin-top: 20px;">
                <strong>Summary:</strong> All top 10 modules show <strong>90-99.8% of dependencies from module.level2</strong>. This confirms systematic <code>depends_on = [module.level2]</code> issue causing all these modules to wait for ~5,000 resources to complete.
            </div>

            <h3>Module Categories Overview</h3>
            <div class="metric-cards">
                <div class="metric-card">
                    <div class="value">470</div>
                    <div class="label">Service Modules</div>
                </div>
                <div class="metric-card warning">
                    <div class="value">1,185</div>
                    <div class="label">MySQL Modules</div>
                </div>
                <div class="metric-card danger">
                    <div class="value">5</div>
                    <div class="label">Ingress Modules</div>
                </div>
                <div class="metric-card">
                    <div class="value">129</div>
                    <div class="label">Monitoring Modules</div>
                </div>
            </div>

            <h3>Ingress Resources Comparison</h3>
            <div class="highlight-box" style="background: #e3f2fd; border-color: #2196f3; margin-bottom: 15px;">
                <strong>Terminology:</strong>
                <ul style="margin: 10px 0 0 20px;">
                    <li><strong>Resource Type:</strong> The type in Facets UI (e.g., <code>ingress</code>, <code>service</code>, <code>mysql</code>)</li>
                    <li><strong>Resource Name:</strong> The name given to the resource (e.g., <code>intouch-a</code>, <code>peb-a</code>, <code>metadb</code>)</li>
                    <li><strong>Terraform Module Path:</strong> <code>module.level2.module.{type}_{name}</code> (e.g., <code>module.level2.module.ingress_intouch-a</code>)</li>
                </ul>
            </div>
            <div class="warning-box">
                <strong>Why ingress intouch-a is Critical:</strong> Compare with other ingress resources - they have 50-450 dependencies, but intouch-a has 444,602. This indicates a <code>depends_on = [module.level2]</code> or similar broad dependency.
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Resource Type</th>
                        <th>Resource Name</th>
                        <th>Dependencies</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: #fef2f2;">
                        <td>ingress</td>
                        <td><strong>intouch-a</strong></td>
                        <td style="color: #e74c3c;"><strong>444,602</strong></td>
                        <td><span class="priority-tag priority-high">CRITICAL</span></td>
                    </tr>
                    <tr>
                        <td>ingress</td>
                        <td>tools-a</td>
                        <td style="color: #27ae60;">448</td>
                        <td><span class="priority-tag priority-low">NORMAL</span></td>
                    </tr>
                    <tr>
                        <td>ingress</td>
                        <td>solutions-a</td>
                        <td style="color: #27ae60;">294</td>
                        <td><span class="priority-tag priority-low">NORMAL</span></td>
                    </tr>
                    <tr>
                        <td>ingress</td>
                        <td>glue-a</td>
                        <td style="color: #27ae60;">64</td>
                        <td><span class="priority-tag priority-low">NORMAL</span></td>
                    </tr>
                    <tr>
                        <td>ingress</td>
                        <td>hydra-a</td>
                        <td style="color: #27ae60;">54</td>
                        <td><span class="priority-tag priority-low">NORMAL</span></td>
                    </tr>
                </tbody>
            </table>

            <h3>Service Resources Pattern (Top 10)</h3>
            <div class="highlight-box">
                <strong>Pattern Observed:</strong> 470 service resources in environment, each with 900-5,600 dependencies. This consistent pattern suggests a template-level issue in the service module.
            </div>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Resource Type</th>
                        <th>Resource Name</th>
                        <th>Dependencies</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>1</td><td>service</td><td>internal-intouch-api-a</td><td>5,642</td></tr>
                    <tr><td>2</td><td>service</td><td>intouch-api-read-a</td><td>5,642</td></tr>
                    <tr><td>3</td><td>service</td><td>async-a</td><td>5,372</td></tr>
                    <tr><td>4</td><td>service</td><td>intouch-api-a</td><td>5,172</td></tr>
                    <tr><td>5</td><td>service</td><td>campaign-shard-a</td><td>4,502</td></tr>
                    <tr><td>6</td><td>service</td><td>workflowmanager-runner-a</td><td>4,332</td></tr>
                    <tr><td>7</td><td>service</td><td>workflowmanager-runner-standalone-a</td><td>4,122</td></tr>
                    <tr><td>8</td><td>service</td><td>intouch-api-v3-jsvt</td><td>3,970</td></tr>
                    <tr><td>9</td><td>service</td><td>peb-a</td><td>3,551</td></tr>
                    <tr><td>10</td><td>service</td><td>emf-a</td><td>3,495</td></tr>
                </tbody>
            </table>

            <div class="action-item">
                <h5>Immediate Actions Required</h5>
                <ol style="margin-left: 20px;">
                    <li><strong>ingress_intouch-a:</strong> Find and remove <code>depends_on = [module.level2]</code> - should only depend on nginx + cert</li>
                    <li><strong>module.application:</strong> Review why 15 resources have 577K dependencies - likely module-level depends_on</li>
                    <li><strong>Service module template:</strong> Check common template for unnecessary dependencies</li>
                </ol>
            </div>
        </div>

        <!-- Removable Dependencies Section -->
        <div class="section actionable">
            <h2>Dependencies Optimization Analysis</h2>
            <p style="margin-bottom: 20px;">The following dependencies can potentially be optimized to reduce release time:</p>

            <div class="root-cause-item" style="border-left: 4px solid #e74c3c;">
                <h4><span class="icon">1</span> Resources with EXCESSIVE Dependencies (Fan-In) <span class="priority-tag priority-high">OPTIMIZE</span></h4>
                <p>These resources wait for an abnormally high number of dependencies - likely due to unnecessary <code>depends_on</code> blocks:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Resource</th>
                            <th>Type</th>
                            <th>Waits For</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>example_ingress</strong></td>
                            <td>kubernetes_ingress_v1</td>
                            <td>441,210 deps</td>
                            <td><span class="priority-tag priority-high">AUDIT</span></td>
                        </tr>
                        <tr>
                            <td><strong>mysql_grants</strong></td>
                            <td>mysql_grant</td>
                            <td>107,440 deps</td>
                            <td><span class="priority-tag priority-high">AUDIT</span></td>
                        </tr>
                        <tr>
                            <td><strong>mysql_user</strong></td>
                            <td>mysql_user</td>
                            <td>107,372 deps</td>
                            <td><span class="priority-tag priority-high">AUDIT</span></td>
                        </tr>
                        <tr>
                            <td>random_password</td>
                            <td>random_string</td>
                            <td>107,236 deps</td>
                            <td><span class="priority-tag priority-medium">REVIEW</span></td>
                        </tr>
                        <tr>
                            <td>qasuite_cronjob</td>
                            <td>helm_release</td>
                            <td>36,363 deps</td>
                            <td><span class="priority-tag priority-medium">REVIEW</span></td>
                        </tr>
                        <tr>
                            <td>cronjob</td>
                            <td>helm_release</td>
                            <td>23,715 deps</td>
                            <td><span class="priority-tag priority-medium">REVIEW</span></td>
                        </tr>
                    </tbody>
                </table>

                <div class="action-item">
                    <h5>Recommended Action:</h5>
                    <p>Review the Terraform modules for these resources. Look for explicit <code>depends_on</code> blocks that may be pulling in entire module outputs unnecessarily. Remove dependencies that Terraform would infer automatically.</p>
                </div>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #f39c12;">
                <h4><span class="icon">2</span> Bottleneck Resources (Fan-Out) <span class="priority-tag priority-medium">OPTIMIZE</span></h4>
                <p>These resources block many others - consider if all downstream resources truly need this dependency:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Resource</th>
                            <th>Type</th>
                            <th>Blocks (edges)</th>
                            <th>Impact</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>base-domain-zone</strong></td>
                            <td>data.aws_route53_zone</td>
                            <td>9,872 edges</td>
                            <td><span class="priority-tag priority-high">CRITICAL</span></td>
                        </tr>
                        <tr>
                            <td><strong>tooling-vpc</strong></td>
                            <td>data.aws_vpc</td>
                            <td>9,872 edges</td>
                            <td><span class="priority-tag priority-high">CRITICAL</span></td>
                        </tr>
                        <tr>
                            <td><strong>release_metadata</strong></td>
                            <td>scratch_string</td>
                            <td>9,547 edges</td>
                            <td><span class="priority-tag priority-high">CRITICAL</span></td>
                        </tr>
                        <tr>
                            <td>db_parameter_group</td>
                            <td>aws_db_parameter_group</td>
                            <td>4,528 edges</td>
                            <td><span class="priority-tag priority-medium">HIGH</span></td>
                        </tr>
                        <tr>
                            <td>master_password</td>
                            <td>random_password</td>
                            <td>4,528 edges</td>
                            <td><span class="priority-tag priority-medium">HIGH</span></td>
                        </tr>
                    </tbody>
                </table>

                <div class="action-item">
                    <h5>Recommended Action:</h5>
                    <p>These data sources and metadata resources may be fetched once and passed to modules. Verify if every resource truly needs a direct dependency on these. Consider moving to <code>terraform_remote_state</code> or locals for static data.</p>
                </div>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #9b59b6;">
                <h4><span class="icon">3</span> Scratch String Dependencies <span class="priority-tag priority-medium">REVIEW</span></h4>
                <p>Many resources have dependencies on <code>scratch_string</code> resources which are metadata - these may be unnecessary:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Resource</th>
                            <th>Scratch Deps</th>
                            <th>Total Deps</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>mysql_grants</td>
                            <td>14,144</td>
                            <td>107,440</td>
                            <td>13.2%</td>
                        </tr>
                        <tr>
                            <td>mysql_user</td>
                            <td>14,144</td>
                            <td>107,372</td>
                            <td>13.2%</td>
                        </tr>
                        <tr>
                            <td>qasuite_cronjob</td>
                            <td>4,784</td>
                            <td>36,363</td>
                            <td>13.2%</td>
                        </tr>
                        <tr>
                            <td>cronjob</td>
                            <td>3,120</td>
                            <td>23,715</td>
                            <td>13.2%</td>
                        </tr>
                        <tr>
                            <td>mysql_grants_sibling</td>
                            <td>3,120</td>
                            <td>23,700</td>
                            <td>13.2%</td>
                        </tr>
                    </tbody>
                </table>

                <div class="action-item">
                    <h5>Recommended Action:</h5>
                    <p><code>scratch_string</code> resources are typically used for metadata/release tracking. If they're being passed as dependencies to downstream resources unnecessarily, remove those dependency links.</p>
                </div>
            </div>
        </div>

        <!-- Module-Level depends_on Problem - DETAILED EXPLANATION -->
        <div class="section critical-finding">
            <h2>Critical Issue: Module-Level depends_on</h2>

            <div class="warning-box">
                <strong>ROOT CAUSE:</strong> When you write <code>depends_on = [module.xyz]</code>, Terraform creates a dependency edge from <strong>EVERY resource inside that module</strong> to your resource. This is why <code>example_ingress</code> has 441,210 dependencies.
            </div>

            <h3>What module.level2 Contains (~5,000+ resources)</h3>
            <div class="dep-chain">
module.level2 contains:<br>
├── helm_release.app1<br>
├── helm_release.app2<br>
├── helm_release.app3<br>
├── ... (1,228 helm releases)<br>
├── kubernetes_secret.secret1<br>
├── kubernetes_secret.secret2<br>
├── ... (332 secrets)<br>
├── aws_iam_role.role1<br>
├── ... (249 IAM roles)<br>
└── ... (total ~5,000+ resources)
            </div>

            <div class="two-column">
                <div class="root-cause-item" style="border-left: 4px solid #e74c3c;">
                    <h4 style="color: #e74c3c;">BAD: Module-Level depends_on</h4>
                    <div class="code-block">
resource "kubernetes_ingress_v1" "example_ingress" {
  depends_on = [module.level2]  # BAD!
}
                    </div>
                    <p style="margin-top: 10px;"><strong>What Terraform does:</strong></p>
                    <div class="dep-chain" style="font-size: 0.8em;">
example_ingress must wait for:<br>
├── helm_release.app1 ──────────┐<br>
├── helm_release.app2 ──────────┤<br>
├── ... (1,228 helm releases) ──┤<br>
├── kubernetes_secret.* ────────┼──→ example_ingress<br>
├── aws_iam_role.* ─────────────┤<br>
└── ALL 5,000+ resources ───────┘<br>
<br>
<strong>Total: 441,210 dependency edges!</strong>
                    </div>
                </div>
                <div class="root-cause-item" style="border-left: 4px solid #27ae60;">
                    <h4 style="color: #27ae60;">GOOD: Specific depends_on</h4>
                    <div class="code-block">
resource "kubernetes_ingress_v1" "example_ingress" {
  depends_on = [
    helm_release.nginx_ingress_controller
  ]  # Just 1 dep!
}
                    </div>
                    <p style="margin-top: 10px;"><strong>What Terraform does:</strong></p>
                    <div class="dep-chain" style="font-size: 0.8em;">
example_ingress must wait for:<br>
└── helm_release.nginx_controller ──→ example_ingress<br>
<br>
<br>
<br>
<br>
<strong>Total: 1 dependency edge</strong>
                    </div>
                </div>
            </div>

            <h3>Impact on Release Time</h3>
            <div class="warning-box" style="margin-bottom: 15px;">
                <strong>Current Observed Times (from graphs):</strong> Based on your release data, full releases currently take <strong>10-27 minutes</strong> (Nightly: 16-17 min, Production varies by region). Even with 441K dependencies, Terraform parallelizes many operations, so the issue manifests as <strong>gradually increasing release times</strong> rather than full sequential execution.
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Scenario</th>
                        <th>Dependencies</th>
                        <th>Execution</th>
                        <th>Current Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>depends_on = [module.level2]</code></td>
                        <td>441,210</td>
                        <td>Partially sequential</td>
                        <td style="color: #e74c3c;"><strong>16-27 min</strong></td>
                    </tr>
                    <tr>
                        <td><code>depends_on = [helm_release.nginx]</code></td>
                        <td>1</td>
                        <td>Optimal parallelization</td>
                        <td style="color: #27ae60;"><strong>6-10 min</strong></td>
                    </tr>
                    <tr>
                        <td>No depends_on (use references)</td>
                        <td>Auto-inferred</td>
                        <td>Maximum parallelization</td>
                        <td style="color: #27ae60;"><strong>5-8 min</strong></td>
                    </tr>
                </tbody>
            </table>

        </div>

        <!-- Resource Type Dependency Graph -->
        <div class="section">
            <h2>Terraform Resource Type Dependency Graph (Top 10)</h2>
            <div class="warning-box" style="margin-bottom: 20px;">
                <strong>⚠️ Note:</strong> This section shows <strong>Terraform resource types</strong> (low-level implementation: scratch_string, helm_release, etc.), NOT Facets resource types. This analyzes how Terraform resources depend on each other under the hood.
            </div>
            <p style="margin-bottom: 20px;">Visual representation of how the top 10 Terraform resource types are connected through dependency edges:</p>

            <div class="two-column">
                <div>
                    <h3>Top 10 Resource Types (Vertices)</h3>
                    <table>
                        <thead>
                            <tr><th>#</th><th>Resource Type</th><th>Count</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>1</td><td>scratch_string</td><td>1,478</td></tr>
                            <tr><td>2</td><td>helm_release</td><td>1,228</td></tr>
                            <tr><td>3</td><td>facets_tekton_action</td><td>651</td></tr>
                            <tr><td>4</td><td>random_password</td><td>464</td></tr>
                            <tr><td>5</td><td>kubernetes_secret</td><td>332</td></tr>
                            <tr><td>6</td><td>aws_iam_role</td><td>249</td></tr>
                            <tr><td>7</td><td>kubernetes_config_map</td><td>132</td></tr>
                            <tr><td>8</td><td>kubernetes_pvc</td><td>130</td></tr>
                            <tr><td>9</td><td>random_string</td><td>118</td></tr>
                            <tr><td>10</td><td>aws_iam_role_policy</td><td>112</td></tr>
                        </tbody>
                    </table>
                </div>
                <div>
                    <h3>Dependency Flow Diagram</h3>
                    <div style="background: #1a1a2e; padding: 20px; border-radius: 10px; color: white; font-family: monospace; font-size: 12px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <span style="background: #e74c3c; padding: 5px 15px; border-radius: 20px;">scratch_string (1,478)</span>
                        </div>
                        <div style="text-align: center; color: #f39c12;">
                            ▲ 28K &nbsp;&nbsp;&nbsp; ▲ 16K &nbsp;&nbsp;&nbsp; ▲ 10K &nbsp;&nbsp;&nbsp; ▲ 8K
                        </div>
                        <div style="display: flex; justify-content: space-around; margin: 15px 0;">
                            <span style="background: #3498db; padding: 5px 10px; border-radius: 15px; font-size: 10px;">random_string</span>
                            <span style="background: #9b59b6; padding: 5px 10px; border-radius: 15px; font-size: 10px;">helm_release</span>
                            <span style="background: #e67e22; padding: 5px 10px; border-radius: 15px; font-size: 10px;">iam_policy</span>
                            <span style="background: #1abc9c; padding: 5px 10px; border-radius: 15px; font-size: 10px;">tekton_action</span>
                        </div>
                        <div style="text-align: center; color: #f39c12;">
                            │ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │
                        </div>
                        <div style="text-align: center; color: #f39c12;">
                            ▼ 27K &nbsp;&nbsp; ▼ 14K &nbsp;&nbsp; ▼ 9K &nbsp;&nbsp;&nbsp; ▼ 6K
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <span style="background: #9b59b6; padding: 5px 15px; border-radius: 20px;">helm_release (1,228)</span>
                        </div>
                        <div style="text-align: center; color: #f39c12; margin-top: 10px;">
                            ▼ 9K &nbsp;&nbsp;&nbsp;&nbsp; ▼ 6K
                        </div>
                        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px;">
                            <span style="background: #27ae60; padding: 5px 10px; border-radius: 15px; font-size: 10px;">random_password</span>
                            <span style="background: #e67e22; padding: 5px 10px; border-radius: 15px; font-size: 10px;">aws_iam_role</span>
                        </div>
                    </div>
                </div>
            </div>

            <h3>Top Dependency Edges (Connections Between Types)</h3>
            <div class="chart-container" style="height: 400px;">
                <canvas id="edgeFlowChart"></canvas>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>From Type</th>
                        <th>To Type</th>
                        <th>Edges</th>
                        <th>Can Reduce?</th>
                        <th>How</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>random_string</td>
                        <td>scratch_string</td>
                        <td style="color: #e74c3c;"><strong>28,288</strong></td>
                        <td><span class="priority-tag priority-high">YES</span></td>
                        <td>Use locals for metadata</td>
                    </tr>
                    <tr>
                        <td>random_string</td>
                        <td>helm_release</td>
                        <td style="color: #e74c3c;"><strong>27,200</strong></td>
                        <td><span class="priority-tag priority-medium">PARTIAL</span></td>
                        <td>Review if all helm releases need random strings</td>
                    </tr>
                    <tr>
                        <td>helm_release</td>
                        <td>scratch_string</td>
                        <td style="color: #f39c12;"><strong>16,419</strong></td>
                        <td><span class="priority-tag priority-high">YES</span></td>
                        <td>Remove metadata dependency from helm</td>
                    </tr>
                    <tr>
                        <td>helm_release</td>
                        <td>helm_release</td>
                        <td style="color: #f39c12;"><strong>14,134</strong></td>
                        <td><span class="priority-tag priority-medium">PARTIAL</span></td>
                        <td>Review inter-app dependencies</td>
                    </tr>
                    <tr>
                        <td>iam_policy_attach</td>
                        <td>scratch_string</td>
                        <td><strong>10,341</strong></td>
                        <td><span class="priority-tag priority-high">YES</span></td>
                        <td>IAM doesn't need release metadata</td>
                    </tr>
                </tbody>
            </table>

            <div class="success-box">
                <strong>Potential Reduction:</strong> By converting <code>scratch_string</code> metadata to <code>locals</code>, you can eliminate approximately <strong>63,532 dependency edges</strong> (28K + 16K + 10K + 8K), reducing total edges from 1.48M to ~1.42M.
            </div>
        </div>

        <!-- Dependency Chain Analysis -->
        <div class="section">
            <h2>Dependency Chain Analysis</h2>

            <div class="highlight-box">
                <strong>How to Read Dependency Chains:</strong>
                <p style="margin-top: 10px;">Resource A --> Resource B means B cannot start until A completes. Longer chains = more sequential execution = longer release time.</p>
            </div>

            <h3>Common Dependency Patterns (Over-Templating)</h3>
            <p>These patterns affect many resources - indicates systematic over-dependency:</p>

            <table>
                <thead>
                    <tr>
                        <th>Pattern</th>
                        <th>Affected Resources</th>
                        <th>Issue</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>aws_route53_zone + aws_vpc + scratch_string</code></td>
                        <td>1,094 resources</td>
                        <td>Too many resources depend on base infra</td>
                    </tr>
                    <tr>
                        <td><code>aws_db_parameter_group + kubernetes_config_map + ...</code></td>
                        <td>760 resources</td>
                        <td>Database params blocking K8s resources</td>
                    </tr>
                    <tr>
                        <td><code>aws_appautoscaling_* + aws_db_* + ...</code></td>
                        <td>436 resources</td>
                        <td>Autoscaling tied to database resources</td>
                    </tr>
                    <tr>
                        <td><code>aws_caller_identity + aws_iam_* + ...</code></td>
                        <td>256 resources</td>
                        <td>IAM resources chained unnecessarily</td>
                    </tr>
                </tbody>
            </table>

            <h3>Sample Dependency Chain (Deep Dive)</h3>
            <div class="dep-chain">
                <strong>base-domain-zone</strong> (data.aws_route53_zone)<br>
                &nbsp;&nbsp;&nbsp;|<br>
                &nbsp;&nbsp;&nbsp;+--> release_metadata (scratch_string) [blocks 9,547]<br>
                &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>
                &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+--> mysql_user [waits for 107,372]<br>
                &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>
                &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+--> mysql_grants [waits for 107,440]<br>
                &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>
                &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+--> cronjob (helm_release) [waits for 23,715]<br>
                &nbsp;&nbsp;&nbsp;|<br>
                &nbsp;&nbsp;&nbsp;+--> example_ingress (kubernetes_ingress_v1) [waits for 441,210]<br>
                <br>
                <em>This chain shows how a single data source cascades delays through the system</em>
            </div>
        </div>

        <!-- Actionable Recommendations -->
        <div class="section actionable">
            <h2>Actionable Recommendations to Reduce Release Time</h2>

            <div class="root-cause-item" style="border-left: 4px solid #e74c3c;">
                <h4 style="color: #e74c3c;"><span class="icon">1</span> Remove Unnecessary depends_on Blocks</h4>
                <p><strong>Impact:</strong> HIGH | <strong>Effort:</strong> MEDIUM</p>
                <p style="margin-top: 10px;">Many resources have explicit <code>depends_on</code> that Terraform would infer automatically from references. Check modules for:</p>
                <div class="code-block">
# BEFORE (unnecessary explicit dependency):
resource "kubernetes_ingress_v1" "example_ingress" {
  depends_on = [module.level2]  # Pulls in 441K dependencies!
  ...
}

# AFTER (let Terraform infer from references):
resource "kubernetes_ingress_v1" "example_ingress" {
  # Only reference what you actually need
  metadata {
    annotations = {
      "cert-arn" = aws_acm_certificate.cert.arn  # Terraform infers this dep
    }
  }
}
                </div>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #f39c12;">
                <h4 style="color: #f39c12;"><span class="icon">2</span> Split release_metadata Dependency</h4>
                <p><strong>Impact:</strong> HIGH | <strong>Effort:</strong> MEDIUM</p>
                <p style="margin-top: 10px;">The single <code>release_metadata</code> resource blocks 9,547 others. Consider:</p>
                <ul style="margin: 10px 0 0 20px;">
                    <li>Breaking into smaller, targeted metadata resources</li>
                    <li>Using locals instead of a resource for static metadata</li>
                    <li>Only passing metadata to resources that actually need it</li>
                </ul>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #3498db;">
                <h4 style="color: #3498db;"><span class="icon">3</span> Review base-domain-zone and tooling-vpc</h4>
                <p><strong>Impact:</strong> HIGH | <strong>Effort:</strong> LOW</p>
                <p style="margin-top: 10px;">These data sources block ~10,000 dependency edges each:</p>
                <ul style="margin: 10px 0 0 20px;">
                    <li>Verify if every resource truly needs this data</li>
                    <li>Consider caching the values in locals</li>
                    <li>Move to separate state file for foundational infra</li>
                </ul>
                <div class="code-block">
# Instead of every module referencing:
data.aws_route53_zone.base-domain-zone

# Use locals defined once:
locals {
  base_domain_zone_id = data.aws_route53_zone.base-domain-zone.zone_id
}

# Then reference:
zone_id = local.base_domain_zone_id
                </div>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #9b59b6;">
                <h4 style="color: #9b59b6;"><span class="icon">4</span> Audit mysql_grants and mysql_user Dependencies</h4>
                <p><strong>Impact:</strong> MEDIUM | <strong>Effort:</strong> MEDIUM</p>
                <p style="margin-top: 10px;">These resources wait for 100K+ dependencies each - abnormally high. Check if:</p>
                <ul style="margin: 10px 0 0 20px;">
                    <li>Module-level <code>depends_on</code> is pulling in unnecessary deps</li>
                    <li>References to entire module outputs instead of specific values</li>
                    <li>Implicit dependencies through string interpolation</li>
                </ul>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #27ae60;">
                <h4 style="color: #27ae60;"><span class="icon green">5</span> Split State Files by Domain (Long-term)</h4>
                <p><strong>Impact:</strong> HIGH | <strong>Effort:</strong> HIGH</p>
                <p style="margin-top: 10px;">With 5,452 resources and 1.48M edges, consider splitting:</p>
                <div class="code-block">
# Proposed structure:
states/
  ├── foundation/     # VPC, Route53, base networking
  │                   # Release separately, less frequently
  │
  ├── databases/      # RDS, Redis, MongoDB
  │                   # Has its own dependency graph
  │
  ├── kubernetes/     # EKS cluster, namespaces, RBAC
  │                   # Core K8s infrastructure
  │
  └── applications/   # Helm releases, ConfigMaps, Secrets
                      # Most frequently released
                </div>
            </div>
        </div>



        <div class="section">
            <h2>Summary: Exclusion List Recommendations (Validated)</h2>

            <div class="warning-box" style="margin-bottom: 20px;">
                <strong>⚠️ Important:</strong> The exclusion list in <code>generate.py</code> (lines 1292-1315) expects <strong>Facets resource types</strong> (like <code>iam</code>, <code>aurora</code>, <code>service</code>), NOT Terraform resource types (like <code>helm_release</code>, <code>scratch_string</code>).
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Facets Resource Type</th>
                        <th>Current State</th>
                        <th>Action</th>
                        <th>Expected Impact</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: #d4edda;">
                        <td><strong>iam</strong> (iam_policy)</td>
                        <td>10 instances, 20 TF resources</td>
                        <td><strong>✅ ADD to exclusion list</strong> - Confirmed in Facets UI</td>
                        <td>Moderate reduction (44K deps from IAM modules)</td>
                    </tr>
                    <tr style="background: #d4edda;">
                        <td><strong>aurora</strong></td>
                        <td>30 instances, ~200 TF resources</td>
                        <td><strong>✅ ADD to exclusion list</strong> - Safe to exclude</td>
                        <td>Moderate reduction (DB clusters don't need outputs)</td>
                    </tr>
                    <tr style="background: #fef2f2;">
                        <td><strong>application</strong></td>
                        <td>577,871 deps (legacy module)</td>
                        <td><strong>❌ CANNOT EXCLUDE</strong> - Not a Facets type (root module)</td>
                        <td>N/A - Wrong module pattern</td>
                    </tr>
                    <tr style="background: #fef2f2;">
                        <td><strong>ingress</strong></td>
                        <td>5 instances, 444,602 deps</td>
                        <td><strong>❌ KEEP in outputs</strong> - Critical for routing</td>
                        <td>N/A - Services need ingress resources</td>
                    </tr>
                    <tr style="background: #e8f5e9;">
                        <td><strong>service</strong></td>
                        <td>222 instances, 1,419 TF resources</td>
                        <td><strong>✅ Already excluded</strong></td>
                        <td>Already optimized</td>
                    </tr>
                    <tr style="background: #e8f5e9;">
                        <td><strong>mysql_user</strong></td>
                        <td>Part of mysql (247 instances)</td>
                        <td><strong>✅ Already excluded</strong></td>
                        <td>Already optimized</td>
                    </tr>
                </tbody>
            </table>

            <div class="success-box" style="margin-top: 20px;">
                <strong>Expected Improvement:</strong> Adding <code>iam</code> and <code>aurora</code> to the exclusion list will reduce unnecessary dependencies by <strong>10-15%</strong>, improving release times by an estimated <strong>1-2 minutes</strong>.
            </div>
        <!-- Facets Resource Type Distribution -->
        </div>

        <!-- Next Steps -->
        <div class="section">
            <h2>Implementation Steps</h2>

            <div class="highlight-box">
                <strong>To implement the exclusion list updates:</strong>
                <ol style="margin: 10px 0 0 20px;">
                    <li><strong>Backup the file:</strong> <code>cp generate.py generate.py.backup</code></li>
                    <li><strong>Edit generate.py</strong> (lines 1292-1315) and add:
                        <ul style="margin-top: 5px;">
                            <li><code>"iam",</code> - to exclude IAM policy resources</li>
                            <li><code>"aurora",</code> - to exclude Aurora database clusters</li>
                        </ul>
                    </li>
                    <li><strong>Generate new module:</strong> <code>python3 generate.py &lt;stack&gt; &lt;cloud&gt; &lt;release_type&gt;</code></li>
                    <li><strong>Verify outputs:</strong> Check <code>level2/module_outputs.tf</code> to confirm <code>iam</code> and <code>aurora</code> are NOT present</li>
                    <li><strong>Test deployment</strong> in development environment first</li>
                    <li><strong>Measure release time</strong> improvement (expected: 1-2 minutes faster)</li>
                    <li><strong>Apply to other environments</strong> if successful</li>
                </ol>
            </div>

            <h3>File Locations</h3>
            <ul style="margin: 10px 0 0 20px;">
                <li><strong>Exclusion list:</strong> <code>/Users/abhishtbagewadi/Documents/facets-iac-tfdev/capillary-cloud-tf/tfmain/scripts/generate.py</code> (lines 1292-1315)</li>
                <li><strong>Recommendations:</strong> <code>/Users/abhishtbagewadi/Documents/EXCLUSION_LIST_RECOMMENDATIONS_FINAL.md</code></li>
                <li><strong>State file:</strong> <code>/Users/abhishtbagewadi/Downloads/downloaded-terraform.tfstate</code></li>
            </ul>
        </div>

        <!-- Reference Section -->
        <div class="section" style="background: #f8f9fa;">
            <h2>Reference: Observed Release Duration Trends</h2>
            <p style="color: #666; margin-bottom: 20px;"><em>The following graphs show the observed increase in release duration times that prompted this investigation.</em></p>

            <h3>Non-Production Environment Trends</h3>
            <div class="highlight-box" style="background: #fff; border-color: #dee2e6; margin-bottom: 15px;">
                <strong>Environment Legend:</strong>
                <ul style="margin: 10px 0 0 20px; list-style: disc;">
                    <li><strong>D-FR</strong> = Development Full Release</li>
                    <li><strong>N-FR</strong> = Nightly Full Release</li>
                    <li><strong>S-FR</strong> = Staging Full Release</li>
                </ul>
            </div>
            <div class="chart-container" style="height: 350px;">
                <canvas id="nonProdChart"></canvas>
            </div>

            <h3 style="margin-top: 30px;">Production Environment Trends</h3>
            <div class="chart-container" style="height: 400px;">
                <canvas id="prodChart"></canvas>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Report Generated by Infrastructure Analysis System</p>
            <p>For questions or clarifications, please contact the Facets DevOps/SRE Team</p>
        </div>
    </div>

    <script>
        // Resource Distribution Chart
        const resourceCtx = document.getElementById('resourceChart').getContext('2d');
        new Chart(resourceCtx, {
            type: 'doughnut',
            data: {
                labels: ['helm_release', 'scratch_string', 'tekton_action', 'random_password', 'k8s_secret', 'aws_iam_role', 'Other'],
                datasets: [{
                    data: [1228, 1478, 651, 464, 332, 249, 1050],
                    backgroundColor: ['#e74c3c', '#3498db', '#9b59b6', '#f39c12', '#1abc9c', '#e67e22', '#95a5a6']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Resource Types (5,452 total)' },
                    legend: { position: 'bottom', labels: { boxWidth: 12 } }
                }
            }
        });

        // Non-Production Chart
        const nonProdCtx = document.getElementById('nonProdChart').getContext('2d');
        new Chart(nonProdCtx, {
            type: 'line',
            data: {
                labels: ['17-23 Sept', '24-30 Sept', '1-7 Oct', '8-15 Oct'],
                datasets: [{
                    label: 'D-FR (Development)',
                    data: [9.95, 10.18, 10.87, 11.22],
                    borderColor: '#27ae60',
                    tension: 0.4,
                    borderWidth: 3
                }, {
                    label: 'N-FR (Nightly)',
                    data: [13.235, 14.67, 15.665, 16.62],
                    borderColor: '#2980b9',
                    tension: 0.4,
                    borderWidth: 3
                }, {
                    label: 'S-FR (Staging)',
                    data: [null, 13.905, null, 16.06],
                    borderColor: '#1a5276',
                    tension: 0.4,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Non-Production Full Release Duration (Minutes)' },
                    legend: { position: 'top' }
                },
                scales: { y: { beginAtZero: true, max: 20 } }
            }
        });

        // Edge Flow Chart (Resource Type Dependencies)
        const edgeFlowCtx = document.getElementById('edgeFlowChart').getContext('2d');
        new Chart(edgeFlowCtx, {
            type: 'bar',
            data: {
                labels: [
                    'random_string → scratch_string',
                    'random_string → helm_release',
                    'helm_release → scratch_string',
                    'helm_release → helm_release',
                    'random_string → random_password',
                    'iam_policy → scratch_string',
                    'iam_policy → helm_release',
                    'helm_release → random_password',
                    'tekton_action → scratch_string',
                    'random_string → aws_iam_role'
                ],
                datasets: [{
                    label: 'Dependency Edges',
                    data: [28288, 27200, 16419, 14134, 12376, 10341, 9249, 9059, 8484, 8432],
                    backgroundColor: [
                        '#e74c3c', '#e74c3c', '#f39c12', '#f39c12', '#3498db',
                        '#e74c3c', '#9b59b6', '#3498db', '#e74c3c', '#3498db'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Top 10 Dependency Edges Between Resource Types' },
                    legend: { display: false }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: 'Number of Edges' }
                    }
                }
            }
        });

        // Production Chart
        const prodCtx = document.getElementById('prodChart').getContext('2d');
        new Chart(prodCtx, {
            type: 'line',
            data: {
                labels: ['17-23 Sept', '24-30 Sept', '1-7 Oct', '8-15 Oct'],
                datasets: [
                    { label: 'EU-FR', data: [27, 27.5, 27.5, 27], borderColor: '#1a5276', tension: 0.4, borderWidth: 2 },
                    { label: 'Asia-FR', data: [22, 16, 16, 16], borderColor: '#27ae60', tension: 0.4, borderWidth: 2 },
                    { label: 'USHC-FR', data: [17, 0, 15.5, 21], borderColor: '#2980b9', tension: 0.4, borderWidth: 2 },
                    { label: 'SEACRM-FR', data: [12, 14, 15, 17], borderColor: '#16a085', tension: 0.4, borderWidth: 2 },
                    { label: 'I-FR', data: [10, 12, 15, 15], borderColor: '#8e44ad', tension: 0.4, borderWidth: 2 },
                    { label: 'Tata-FR', data: [11, 12, 13, 14], borderColor: '#e67e22', tension: 0.4, borderWidth: 2 },
                    { label: 'SGFR', data: [6.5, 7, 7, 7], borderColor: '#e91e63', tension: 0.4, borderWidth: 2 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Production Full Release Duration (Minutes)' },
                    legend: { position: 'right' }
                },
                scales: { y: { beginAtZero: true, max: 30 } }
            }
        });

        // Facets Resource Type Distribution Chart
        const facetsCtx = document.getElementById('facetsTypeChart').getContext('2d');
        new Chart(facetsCtx, {
            type: 'bar',
            data: {
                labels: [
                    'k8s', 'mysql', 'service', 'grafana', 'helm', 'mongo', 'alert',
                    'iam', 's3', 'kubernetes', 'aws', 'rabbitmq', 'ingress', 'kafka',
                    'prometheus', 'elasticsearch', 'snapshot', 'redis', 'config', 'loki',
                    'cloudflare-gw', 'alerts', 'argo', 'cert', 'cloudflare', 'leaked',
                    'log', 'mongodb', 'natgateway', 'network'
                ],
                datasets: [{
                    label: 'Number of Instances',
                    data: [
                        514, 247, 222, 107, 34, 33, 20,
                        10, 9, 8, 7, 6, 5, 5,
                        5, 3, 3, 2, 2, 2,
                        2, 1, 1, 1, 1, 1,
                        1, 1, 1, 1
                    ],
                    backgroundColor: function(context) {
                        const value = context.parsed.y;
                        if (value > 100) return 'rgba(231, 76, 60, 0.8)';  // Red - very high
                        if (value > 50) return 'rgba(230, 126, 34, 0.8)';   // Orange - high
                        if (value > 20) return 'rgba(241, 196, 15, 0.8)';   // Yellow - medium
                        if (value > 5) return 'rgba(52, 152, 219, 0.8)';    // Blue - low
                        return 'rgba(149, 165, 166, 0.8)';                  // Gray - very low
                    },
                    borderColor: function(context) {
                        const value = context.parsed.y;
                        if (value > 100) return 'rgba(231, 76, 60, 1)';
                        if (value > 50) return 'rgba(230, 126, 34, 1)';
                        if (value > 20) return 'rgba(241, 196, 15, 1)';
                        if (value > 5) return 'rgba(52, 152, 219, 1)';
                        return 'rgba(149, 165, 166, 1)';
                    },
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Facets Resource Types - Instance Count Distribution',
                        font: { size: 16 }
                    },
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            generateLabels: function() {
                                return [
                                    { text: 'Very High (>100)', fillStyle: 'rgba(231, 76, 60, 0.8)', strokeStyle: 'rgba(231, 76, 60, 1)', lineWidth: 2 },
                                    { text: 'High (50-100)', fillStyle: 'rgba(230, 126, 34, 0.8)', strokeStyle: 'rgba(230, 126, 34, 1)', lineWidth: 2 },
                                    { text: 'Medium (20-50)', fillStyle: 'rgba(241, 196, 15, 0.8)', strokeStyle: 'rgba(241, 196, 15, 1)', lineWidth: 2 },
                                    { text: 'Low (5-20)', fillStyle: 'rgba(52, 152, 219, 0.8)', strokeStyle: 'rgba(52, 152, 219, 1)', lineWidth: 2 },
                                    { text: 'Very Low (<5)', fillStyle: 'rgba(149, 165, 166, 0.8)', strokeStyle: 'rgba(149, 165, 166, 1)', lineWidth: 2 }
                                ];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const label = context.label;
                                const descriptions = {
                                    'k8s': 'Kubernetes resources (clusters, roles, etc.)',
                                    'mysql': 'MySQL databases (247 instances = 1,687 TF resources)',
                                    'service': '✅ Already excluded from outputs',
                                    'grafana': 'Monitoring dashboards',
                                    'iam': '✅ RECOMMENDED: Add to exclusion list',
                                    'aurora': '✅ RECOMMENDED: Add to exclusion list',
                                    'ingress': '❌ Must KEEP in outputs (critical for routing)',
                                    'kafka': 'Message queues',
                                    'mongo': 'MongoDB databases',
                                    'redis': 'Redis caches',
                                    's3': 'S3 buckets'
                                };
                                return descriptions[label] || '';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Facets Resource Type'
                        },
                        ticks: {
                            autoSkip: false,
                            maxRotation: 90,
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Instances'
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
