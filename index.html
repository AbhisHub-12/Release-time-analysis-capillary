<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Release Duration Analysis Report - Removable Dependencies Investigation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #1a5276 0%, #2980b9 100%); color: white; padding: 40px; text-align: center; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header .subtitle { font-size: 1.2em; opacity: 0.9; }
        .header .date { margin-top: 15px; font-size: 0.95em; opacity: 0.8; }
        .section { background: white; border-radius: 10px; padding: 30px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section h2 { color: #1a5276; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.8em; }
        .section h3 { color: #2c3e50; margin: 20px 0 15px 0; font-size: 1.3em; }
        .executive-summary { background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%); border-left: 5px solid #f39c12; }
        .critical-finding { background: #fef2f2; border-left: 5px solid #e74c3c; }
        .actionable { background: #e8f5e9; border-left: 5px solid #27ae60; }
        .chart-container { position: relative; height: 350px; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #1a5276; color: white; font-weight: 600; }
        tr:nth-child(even) { background: #f8f9fa; }
        tr:hover { background: #e8f4f8; }
        .metric-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .metric-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .metric-card.warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .metric-card.danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
        .metric-card.success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .metric-card .value { font-size: 2.5em; font-weight: bold; margin-bottom: 5px; }
        .metric-card .label { font-size: 0.95em; opacity: 0.9; }
        .priority-tag { display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 0.75em; font-weight: bold; margin-left: 10px; }
        .priority-high { background: #e74c3c; color: white; }
        .priority-medium { background: #f39c12; color: white; }
        .priority-low { background: #27ae60; color: white; }
        .highlight-box { background: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; padding: 15px 20px; margin: 15px 0; }
        .warning-box { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px 20px; margin: 15px 0; }
        .success-box { background: #d4edda; border: 1px solid #28a745; border-radius: 8px; padding: 15px 20px; margin: 15px 0; }
        .root-cause-item { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .root-cause-item h4 { color: #c0392b; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .icon { width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; background: #e74c3c; color: white; border-radius: 50%; font-size: 14px; }
        .icon.green { background: #27ae60; }
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 768px) { .two-column { grid-template-columns: 1fr; } }
        .footer { text-align: center; padding: 20px; color: #666; font-size: 0.9em; }
        .code-block { background: #2d3436; color: #dfe6e9; padding: 15px 20px; border-radius: 8px; font-family: 'Courier New', monospace; overflow-x: auto; margin: 10px 0; font-size: 0.9em; }
        .dep-chain { background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; margin: 10px 0; border-left: 4px solid #3498db; font-size: 0.85em; }
        .action-item { background: #e8f5e9; border-left: 4px solid #27ae60; padding: 15px; margin: 10px 0; border-radius: 0 8px 8px 0; }
        .action-item h5 { color: #27ae60; margin-bottom: 8px; }
        @media print { .section { break-inside: avoid; } body { background: white; } }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Release Duration Analysis Report</h1>
            <div class="subtitle">Removable Dependencies Investigation - Terraform State Analysis</div>
            <div class="date">Report Generated: December 4, 2025</div>
        </div>

        <!-- Executive Summary -->
        <div class="section executive-summary">
            <h2>Executive Summary</h2>
            <p>This report identifies <strong>removable and unnecessary dependencies</strong> in the Terraform state file that are causing increased release times. Focus is on actionable findings that can reduce release duration.</p>

            <div class="metric-cards">
                <div class="metric-card">
                    <div class="value">5,452</div>
                    <div class="label">Total Resources (Vertices)</div>
                </div>
                <div class="metric-card danger">
                    <div class="value">1.48M</div>
                    <div class="label">Dependency Edges</div>
                </div>
                <div class="metric-card warning">
                    <div class="value">441K</div>
                    <div class="label">Max Fan-In (example_ingress)</div>
                </div>
                <div class="metric-card success">
                    <div class="value">5</div>
                    <div class="label">Key Optimizations Found</div>
                </div>
            </div>

            <div class="success-box">
                <strong>Key Finding:</strong> Resources like <code>example_ingress</code> have <strong>441,210 dependency edges</strong> - far exceeding normal patterns. This indicates unnecessary <code>depends_on</code> configurations that can be removed to reduce release time.
            </div>
        </div>

        <!-- Understanding Dependencies -->
        <div class="section">
            <h2>Understanding Dependency Analysis</h2>

            <div class="warning-box">
                <strong>Important Clarification: Edges vs Resources</strong>
                <p style="margin-top: 10px;">The "blocks X resources" count represents <strong>dependency edges</strong>, not unique resources. When a resource like <code>base-domain-zone</code> shows "blocks 9,872" it means:</p>
                <ul style="margin: 10px 0 0 20px;">
                    <li>There are 9,872 <strong>dependency connections</strong> pointing to this resource</li>
                    <li>Multiple resources may have multiple edges to the same bottleneck</li>
                    <li>Total unique resources in state: <strong>5,452</strong></li>
                    <li>Total dependency edges: <strong>1,483,106</strong></li>
                </ul>
            </div>

            <div class="highlight-box">
                <strong>Fan-In vs Fan-Out:</strong>
                <ul style="margin: 10px 0 0 20px;">
                    <li><strong>Fan-In (Excessive Dependencies)</strong> = Resource waits for too many others before it can start</li>
                    <li><strong>Fan-Out (Bottleneck)</strong> = Resource blocks too many others from starting</li>
                    <li><strong>Goal:</strong> Reduce unnecessary dependencies to allow more parallelization</li>
                </ul>
            </div>

            <div class="two-column">
                <div>
                    <h3>Graph Statistics</h3>
                    <table>
                        <tr><td>Total Vertices (Resources)</td><td><strong>5,452</strong></td></tr>
                        <tr><td>Total Edges (Dependencies)</td><td><strong>1,483,106</strong></td></tr>
                        <tr><td>Resources WITH dependencies</td><td>4,368</td></tr>
                        <tr><td>Resources WITHOUT dependencies</td><td>1,084</td></tr>
                        <tr><td>Average edges per vertex</td><td>272.03</td></tr>
                        <tr><td>Critical Path Depth</td><td>21 resources</td></tr>
                    </table>
                </div>
                <div>
                    <h3>Resource Type Distribution</h3>
                    <div class="chart-container">
                        <canvas id="resourceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Removable Dependencies Section -->
        <div class="section actionable">
            <h2>Dependencies Optimization Analysis</h2>
            <p style="margin-bottom: 20px;">The following dependencies can potentially be optimized to reduce release time:</p>

            <div class="root-cause-item" style="border-left: 4px solid #e74c3c;">
                <h4><span class="icon">1</span> Resources with EXCESSIVE Dependencies (Fan-In) <span class="priority-tag priority-high">OPTIMIZE</span></h4>
                <p>These resources wait for an abnormally high number of dependencies - likely due to unnecessary <code>depends_on</code> blocks:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Resource</th>
                            <th>Type</th>
                            <th>Waits For</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>example_ingress</strong></td>
                            <td>kubernetes_ingress_v1</td>
                            <td>441,210 deps</td>
                            <td><span class="priority-tag priority-high">AUDIT</span></td>
                        </tr>
                        <tr>
                            <td><strong>mysql_grants</strong></td>
                            <td>mysql_grant</td>
                            <td>107,440 deps</td>
                            <td><span class="priority-tag priority-high">AUDIT</span></td>
                        </tr>
                        <tr>
                            <td><strong>mysql_user</strong></td>
                            <td>mysql_user</td>
                            <td>107,372 deps</td>
                            <td><span class="priority-tag priority-high">AUDIT</span></td>
                        </tr>
                        <tr>
                            <td>random_password</td>
                            <td>random_string</td>
                            <td>107,236 deps</td>
                            <td><span class="priority-tag priority-medium">REVIEW</span></td>
                        </tr>
                        <tr>
                            <td>qasuite_cronjob</td>
                            <td>helm_release</td>
                            <td>36,363 deps</td>
                            <td><span class="priority-tag priority-medium">REVIEW</span></td>
                        </tr>
                        <tr>
                            <td>cronjob</td>
                            <td>helm_release</td>
                            <td>23,715 deps</td>
                            <td><span class="priority-tag priority-medium">REVIEW</span></td>
                        </tr>
                    </tbody>
                </table>

                <div class="action-item">
                    <h5>Recommended Action:</h5>
                    <p>Review the Terraform modules for these resources. Look for explicit <code>depends_on</code> blocks that may be pulling in entire module outputs unnecessarily. Remove dependencies that Terraform would infer automatically.</p>
                </div>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #f39c12;">
                <h4><span class="icon">2</span> Bottleneck Resources (Fan-Out) <span class="priority-tag priority-medium">OPTIMIZE</span></h4>
                <p>These resources block many others - consider if all downstream resources truly need this dependency:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Resource</th>
                            <th>Type</th>
                            <th>Blocks (edges)</th>
                            <th>Impact</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>base-domain-zone</strong></td>
                            <td>data.aws_route53_zone</td>
                            <td>9,872 edges</td>
                            <td><span class="priority-tag priority-high">CRITICAL</span></td>
                        </tr>
                        <tr>
                            <td><strong>tooling-vpc</strong></td>
                            <td>data.aws_vpc</td>
                            <td>9,872 edges</td>
                            <td><span class="priority-tag priority-high">CRITICAL</span></td>
                        </tr>
                        <tr>
                            <td><strong>release_metadata</strong></td>
                            <td>scratch_string</td>
                            <td>9,547 edges</td>
                            <td><span class="priority-tag priority-high">CRITICAL</span></td>
                        </tr>
                        <tr>
                            <td>db_parameter_group</td>
                            <td>aws_db_parameter_group</td>
                            <td>4,528 edges</td>
                            <td><span class="priority-tag priority-medium">HIGH</span></td>
                        </tr>
                        <tr>
                            <td>master_password</td>
                            <td>random_password</td>
                            <td>4,528 edges</td>
                            <td><span class="priority-tag priority-medium">HIGH</span></td>
                        </tr>
                    </tbody>
                </table>

                <div class="action-item">
                    <h5>Recommended Action:</h5>
                    <p>These data sources and metadata resources may be fetched once and passed to modules. Verify if every resource truly needs a direct dependency on these. Consider moving to <code>terraform_remote_state</code> or locals for static data.</p>
                </div>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #9b59b6;">
                <h4><span class="icon">3</span> Scratch String Dependencies <span class="priority-tag priority-medium">REVIEW</span></h4>
                <p>Many resources have dependencies on <code>scratch_string</code> resources which are metadata - these may be unnecessary:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Resource</th>
                            <th>Scratch Deps</th>
                            <th>Total Deps</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>mysql_grants</td>
                            <td>14,144</td>
                            <td>107,440</td>
                            <td>13.2%</td>
                        </tr>
                        <tr>
                            <td>mysql_user</td>
                            <td>14,144</td>
                            <td>107,372</td>
                            <td>13.2%</td>
                        </tr>
                        <tr>
                            <td>qasuite_cronjob</td>
                            <td>4,784</td>
                            <td>36,363</td>
                            <td>13.2%</td>
                        </tr>
                        <tr>
                            <td>cronjob</td>
                            <td>3,120</td>
                            <td>23,715</td>
                            <td>13.2%</td>
                        </tr>
                        <tr>
                            <td>mysql_grants_sibling</td>
                            <td>3,120</td>
                            <td>23,700</td>
                            <td>13.2%</td>
                        </tr>
                    </tbody>
                </table>

                <div class="action-item">
                    <h5>Recommended Action:</h5>
                    <p><code>scratch_string</code> resources are typically used for metadata/release tracking. If they're being passed as dependencies to downstream resources unnecessarily, remove those dependency links.</p>
                </div>
            </div>
        </div>

        <!-- Module-Level depends_on Problem - DETAILED EXPLANATION -->
        <div class="section critical-finding">
            <h2>Critical Issue: Module-Level depends_on</h2>

            <div class="warning-box">
                <strong>ROOT CAUSE:</strong> When you write <code>depends_on = [module.xyz]</code>, Terraform creates a dependency edge from <strong>EVERY resource inside that module</strong> to your resource. This is why <code>example_ingress</code> has 441,210 dependencies.
            </div>

            <h3>What module.level2 Contains (~5,000+ resources)</h3>
            <div class="dep-chain">
module.level2 contains:<br>
├── helm_release.app1<br>
├── helm_release.app2<br>
├── helm_release.app3<br>
├── ... (1,228 helm releases)<br>
├── kubernetes_secret.secret1<br>
├── kubernetes_secret.secret2<br>
├── ... (332 secrets)<br>
├── aws_iam_role.role1<br>
├── ... (249 IAM roles)<br>
└── ... (total ~5,000+ resources)
            </div>

            <div class="two-column">
                <div class="root-cause-item" style="border-left: 4px solid #e74c3c;">
                    <h4 style="color: #e74c3c;">BAD: Module-Level depends_on</h4>
                    <div class="code-block">
resource "kubernetes_ingress_v1" "example_ingress" {
  depends_on = [module.level2]  # BAD!
}
                    </div>
                    <p style="margin-top: 10px;"><strong>What Terraform does:</strong></p>
                    <div class="dep-chain" style="font-size: 0.8em;">
example_ingress must wait for:<br>
├── helm_release.app1 ──────────┐<br>
├── helm_release.app2 ──────────┤<br>
├── ... (1,228 helm releases) ──┤<br>
├── kubernetes_secret.* ────────┼──→ example_ingress<br>
├── aws_iam_role.* ─────────────┤<br>
└── ALL 5,000+ resources ───────┘<br>
<br>
<strong>Total: 441,210 dependency edges!</strong>
                    </div>
                </div>
                <div class="root-cause-item" style="border-left: 4px solid #27ae60;">
                    <h4 style="color: #27ae60;">GOOD: Specific depends_on</h4>
                    <div class="code-block">
resource "kubernetes_ingress_v1" "example_ingress" {
  depends_on = [
    helm_release.nginx_ingress_controller
  ]  # Just 1 dep!
}
                    </div>
                    <p style="margin-top: 10px;"><strong>What Terraform does:</strong></p>
                    <div class="dep-chain" style="font-size: 0.8em;">
example_ingress must wait for:<br>
└── helm_release.nginx_controller ──→ example_ingress<br>
<br>
<br>
<br>
<br>
<strong>Total: 1 dependency edge</strong>
                    </div>
                </div>
            </div>

            <h3>Impact on Release Time</h3>
            <table>
                <thead>
                    <tr>
                        <th>Scenario</th>
                        <th>Dependencies</th>
                        <th>Execution</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>depends_on = [module.level2]</code></td>
                        <td>441,210</td>
                        <td>Sequential (waits for ALL)</td>
                        <td style="color: #e74c3c;"><strong>Hours</strong></td>
                    </tr>
                    <tr>
                        <td><code>depends_on = [helm_release.nginx]</code></td>
                        <td>1</td>
                        <td>Parallel (only waits for nginx)</td>
                        <td style="color: #27ae60;"><strong>Seconds</strong></td>
                    </tr>
                    <tr>
                        <td>No depends_on (use references)</td>
                        <td>Auto-inferred</td>
                        <td>Optimal parallelization</td>
                        <td style="color: #27ae60;"><strong>Optimal</strong></td>
                    </tr>
                </tbody>
            </table>

            <h3>Visual Timeline Comparison</h3>
            <div class="two-column">
                <div>
                    <h4 style="color: #e74c3c;">WITH module depends_on (Current)</h4>
                    <div class="dep-chain" style="background: #fef2f2;">
Time 0min   │ app1 starts<br>
Time 0.5min │ app1 done, app2 starts<br>
Time 1min   │ app2 done, app3 starts<br>
...         │ (5,000 resources one by one)<br>
Time 150min │ All done, ingress starts<br>
Time 151min │ Ingress completes<br>
<br>
<strong style="color: #e74c3c;">Total: ~150+ minutes</strong>
                    </div>
                </div>
                <div>
                    <h4 style="color: #27ae60;">WITHOUT module depends_on (Fixed)</h4>
                    <div class="dep-chain" style="background: #e8f5e9;">
Time 0min   │ app1, app2, app3, nginx<br>
            │ ALL start in parallel<br>
Time 0.5min │ nginx done<br>
Time 0.5min │ ingress starts immediately<br>
Time 1min   │ ingress completes<br>
            │ other apps continue parallel<br>
<br>
<strong style="color: #27ae60;">Total: ~1-2 minutes</strong>
                    </div>
                </div>
            </div>

            <div class="action-item">
                <h5>How to Find This in Your Terraform Code</h5>
                <div class="code-block">
# Search for module-level depends_on:
grep -r "depends_on.*module\." --include="*.tf"

# Look for patterns like:
depends_on = [module.level2]
depends_on = [module.environment]
depends_on = [module.mysql_dbmaster]
                </div>
            </div>

            <div class="action-item">
                <h5>The Fix</h5>
                <div class="code-block">
# BEFORE (causes 441K dependencies):
resource "kubernetes_ingress_v1" "example_ingress" {
  depends_on = [module.level2]
}

# AFTER (only 2 dependencies):
resource "kubernetes_ingress_v1" "example_ingress" {
  depends_on = [
    helm_release.nginx_ingress_controller,
    aws_acm_certificate.cert
  ]
}

# BEST (let Terraform auto-infer):
resource "kubernetes_ingress_v1" "example_ingress" {
  # Reference values directly - Terraform infers dependency
  metadata {
    annotations = {
      "cert-arn" = aws_acm_certificate.cert.arn
    }
  }
}
                </div>
            </div>
        </div>

        <!-- Dependency Chain Analysis -->
        <div class="section">
            <h2>Dependency Chain Analysis</h2>

            <div class="highlight-box">
                <strong>How to Read Dependency Chains:</strong>
                <p style="margin-top: 10px;">Resource A --> Resource B means B cannot start until A completes. Longer chains = more sequential execution = longer release time.</p>
            </div>

            <h3>Common Dependency Patterns (Over-Templating)</h3>
            <p>These patterns affect many resources - indicates systematic over-dependency:</p>

            <table>
                <thead>
                    <tr>
                        <th>Pattern</th>
                        <th>Affected Resources</th>
                        <th>Issue</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>aws_route53_zone + aws_vpc + scratch_string</code></td>
                        <td>1,094 resources</td>
                        <td>Too many resources depend on base infra</td>
                    </tr>
                    <tr>
                        <td><code>aws_db_parameter_group + kubernetes_config_map + ...</code></td>
                        <td>760 resources</td>
                        <td>Database params blocking K8s resources</td>
                    </tr>
                    <tr>
                        <td><code>aws_appautoscaling_* + aws_db_* + ...</code></td>
                        <td>436 resources</td>
                        <td>Autoscaling tied to database resources</td>
                    </tr>
                    <tr>
                        <td><code>aws_caller_identity + aws_iam_* + ...</code></td>
                        <td>256 resources</td>
                        <td>IAM resources chained unnecessarily</td>
                    </tr>
                </tbody>
            </table>

            <h3>Sample Dependency Chain (Deep Dive)</h3>
            <div class="dep-chain">
                <strong>base-domain-zone</strong> (data.aws_route53_zone)<br>
                &nbsp;&nbsp;&nbsp;|<br>
                &nbsp;&nbsp;&nbsp;+--> release_metadata (scratch_string) [blocks 9,547]<br>
                &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>
                &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+--> mysql_user [waits for 107,372]<br>
                &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>
                &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+--> mysql_grants [waits for 107,440]<br>
                &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>
                &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+--> cronjob (helm_release) [waits for 23,715]<br>
                &nbsp;&nbsp;&nbsp;|<br>
                &nbsp;&nbsp;&nbsp;+--> example_ingress (kubernetes_ingress_v1) [waits for 441,210]<br>
                <br>
                <em>This chain shows how a single data source cascades delays through the system</em>
            </div>
        </div>

        <!-- Actionable Recommendations -->
        <div class="section actionable">
            <h2>Actionable Recommendations to Reduce Release Time</h2>

            <div class="root-cause-item" style="border-left: 4px solid #e74c3c;">
                <h4 style="color: #e74c3c;"><span class="icon">1</span> Remove Unnecessary depends_on Blocks</h4>
                <p><strong>Impact:</strong> HIGH | <strong>Effort:</strong> MEDIUM</p>
                <p style="margin-top: 10px;">Many resources have explicit <code>depends_on</code> that Terraform would infer automatically from references. Check modules for:</p>
                <div class="code-block">
# BEFORE (unnecessary explicit dependency):
resource "kubernetes_ingress_v1" "example_ingress" {
  depends_on = [module.level2]  # Pulls in 441K dependencies!
  ...
}

# AFTER (let Terraform infer from references):
resource "kubernetes_ingress_v1" "example_ingress" {
  # Only reference what you actually need
  metadata {
    annotations = {
      "cert-arn" = aws_acm_certificate.cert.arn  # Terraform infers this dep
    }
  }
}
                </div>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #f39c12;">
                <h4 style="color: #f39c12;"><span class="icon">2</span> Split release_metadata Dependency</h4>
                <p><strong>Impact:</strong> HIGH | <strong>Effort:</strong> MEDIUM</p>
                <p style="margin-top: 10px;">The single <code>release_metadata</code> resource blocks 9,547 others. Consider:</p>
                <ul style="margin: 10px 0 0 20px;">
                    <li>Breaking into smaller, targeted metadata resources</li>
                    <li>Using locals instead of a resource for static metadata</li>
                    <li>Only passing metadata to resources that actually need it</li>
                </ul>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #3498db;">
                <h4 style="color: #3498db;"><span class="icon">3</span> Review base-domain-zone and tooling-vpc</h4>
                <p><strong>Impact:</strong> HIGH | <strong>Effort:</strong> LOW</p>
                <p style="margin-top: 10px;">These data sources block ~10,000 dependency edges each:</p>
                <ul style="margin: 10px 0 0 20px;">
                    <li>Verify if every resource truly needs this data</li>
                    <li>Consider caching the values in locals</li>
                    <li>Move to separate state file for foundational infra</li>
                </ul>
                <div class="code-block">
# Instead of every module referencing:
data.aws_route53_zone.base-domain-zone

# Use locals defined once:
locals {
  base_domain_zone_id = data.aws_route53_zone.base-domain-zone.zone_id
}

# Then reference:
zone_id = local.base_domain_zone_id
                </div>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #9b59b6;">
                <h4 style="color: #9b59b6;"><span class="icon">4</span> Audit mysql_grants and mysql_user Dependencies</h4>
                <p><strong>Impact:</strong> MEDIUM | <strong>Effort:</strong> MEDIUM</p>
                <p style="margin-top: 10px;">These resources wait for 100K+ dependencies each - abnormally high. Check if:</p>
                <ul style="margin: 10px 0 0 20px;">
                    <li>Module-level <code>depends_on</code> is pulling in unnecessary deps</li>
                    <li>References to entire module outputs instead of specific values</li>
                    <li>Implicit dependencies through string interpolation</li>
                </ul>
            </div>

            <div class="root-cause-item" style="border-left: 4px solid #27ae60;">
                <h4 style="color: #27ae60;"><span class="icon green">5</span> Split State Files by Domain (Long-term)</h4>
                <p><strong>Impact:</strong> HIGH | <strong>Effort:</strong> HIGH</p>
                <p style="margin-top: 10px;">With 5,452 resources and 1.48M edges, consider splitting:</p>
                <div class="code-block">
# Proposed structure:
states/
  ├── foundation/     # VPC, Route53, base networking
  │                   # Release separately, less frequently
  │
  ├── databases/      # RDS, Redis, MongoDB
  │                   # Has its own dependency graph
  │
  ├── kubernetes/     # EKS cluster, namespaces, RBAC
  │                   # Core K8s infrastructure
  │
  └── applications/   # Helm releases, ConfigMaps, Secrets
                      # Most frequently released
                </div>
            </div>
        </div>

        <!-- Summary Table -->
        <div class="section">
            <h2>Summary: Dependencies to Remove/Optimize</h2>

            <table>
                <thead>
                    <tr>
                        <th>Resource</th>
                        <th>Current State</th>
                        <th>Action</th>
                        <th>Expected Impact</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>example_ingress</td>
                        <td>441,210 deps (Fan-In)</td>
                        <td>Remove module-level depends_on</td>
                        <td>Major reduction</td>
                    </tr>
                    <tr>
                        <td>mysql_grants / mysql_user</td>
                        <td>107K deps each</td>
                        <td>Audit module dependencies</td>
                        <td>Major reduction</td>
                    </tr>
                    <tr>
                        <td>base-domain-zone</td>
                        <td>Blocks 9,872 edges</td>
                        <td>Cache in locals, review need</td>
                        <td>Moderate reduction</td>
                    </tr>
                    <tr>
                        <td>release_metadata</td>
                        <td>Blocks 9,547 edges</td>
                        <td>Split or convert to locals</td>
                        <td>Moderate reduction</td>
                    </tr>
                    <tr>
                        <td>scratch_string deps</td>
                        <td>13% of all deps</td>
                        <td>Remove unnecessary metadata deps</td>
                        <td>Minor reduction</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Next Steps -->
        <div class="section">
            <h2>Next Steps</h2>

            <div class="highlight-box">
                <strong>To proceed with optimization:</strong>
                <ol style="margin: 10px 0 0 20px;">
                    <li><strong>Identify the Terraform modules</strong> containing the problematic resources (example_ingress, mysql_grants, etc.)</li>
                    <li><strong>Review depends_on blocks</strong> in those modules - look for broad dependencies like <code>depends_on = [module.xyz]</code></li>
                    <li><strong>Test changes</strong> in development environment first</li>
                    <li><strong>Measure release time</strong> before and after changes</li>
                    <li><strong>Apply to other environments</strong> if successful</li>
                </ol>
            </div>

            <h3>Files to Investigate</h3>
            <p>Based on the analysis, focus on these resource types in your Terraform codebase:</p>
            <ul style="margin: 10px 0 0 20px;">
                <li><code>module.level2.module.ingress_*.kubernetes_ingress_v1.example_ingress</code></li>
                <li><code>module.application.mysql_grant.mysql_grants</code></li>
                <li><code>module.application.mysql_user.mysql_user</code></li>
                <li><code>module.level2.module.environment.scratch_string.release_metadata</code></li>
            </ul>
        </div>

        <!-- Reference Section -->
        <div class="section" style="background: #f8f9fa;">
            <h2>Reference: Observed Release Duration Trends</h2>
            <p style="color: #666; margin-bottom: 20px;"><em>The following graphs show the observed increase in release duration times that prompted this investigation.</em></p>

            <h3>Non-Production Environment Trends</h3>
            <div class="highlight-box" style="background: #fff; border-color: #dee2e6; margin-bottom: 15px;">
                <strong>Environment Legend:</strong>
                <ul style="margin: 10px 0 0 20px; list-style: disc;">
                    <li><strong>D-FR</strong> = Development Full Release</li>
                    <li><strong>N-FR</strong> = Nightly Full Release</li>
                    <li><strong>S-FR</strong> = Staging Full Release</li>
                </ul>
            </div>
            <div class="chart-container" style="height: 350px;">
                <canvas id="nonProdChart"></canvas>
            </div>

            <h3 style="margin-top: 30px;">Production Environment Trends</h3>
            <div class="chart-container" style="height: 400px;">
                <canvas id="prodChart"></canvas>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Report Generated by Infrastructure Analysis System</p>
            <p>For questions or clarifications, please contact the Facets DevOps/SRE Team</p>
        </div>
    </div>

    <script>
        // Resource Distribution Chart
        const resourceCtx = document.getElementById('resourceChart').getContext('2d');
        new Chart(resourceCtx, {
            type: 'doughnut',
            data: {
                labels: ['helm_release', 'scratch_string', 'tekton_action', 'random_password', 'k8s_secret', 'aws_iam_role', 'Other'],
                datasets: [{
                    data: [1228, 1478, 651, 464, 332, 249, 1050],
                    backgroundColor: ['#e74c3c', '#3498db', '#9b59b6', '#f39c12', '#1abc9c', '#e67e22', '#95a5a6']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Resource Types (5,452 total)' },
                    legend: { position: 'bottom', labels: { boxWidth: 12 } }
                }
            }
        });

        // Non-Production Chart
        const nonProdCtx = document.getElementById('nonProdChart').getContext('2d');
        new Chart(nonProdCtx, {
            type: 'line',
            data: {
                labels: ['17-23 Sept', '24-30 Sept', '1-7 Oct', '8-15 Oct'],
                datasets: [{
                    label: 'D-FR (Development)',
                    data: [9.95, 10.18, 10.87, 11.22],
                    borderColor: '#27ae60',
                    tension: 0.4,
                    borderWidth: 3
                }, {
                    label: 'N-FR (Nightly)',
                    data: [13.235, 14.67, 15.665, 16.62],
                    borderColor: '#2980b9',
                    tension: 0.4,
                    borderWidth: 3
                }, {
                    label: 'S-FR (Staging)',
                    data: [null, 13.905, null, 16.06],
                    borderColor: '#1a5276',
                    tension: 0.4,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Non-Production Full Release Duration (Minutes)' },
                    legend: { position: 'top' }
                },
                scales: { y: { beginAtZero: true, max: 20 } }
            }
        });

        // Production Chart
        const prodCtx = document.getElementById('prodChart').getContext('2d');
        new Chart(prodCtx, {
            type: 'line',
            data: {
                labels: ['17-23 Sept', '24-30 Sept', '1-7 Oct', '8-15 Oct'],
                datasets: [
                    { label: 'EU-FR', data: [27, 27.5, 27.5, 27], borderColor: '#1a5276', tension: 0.4, borderWidth: 2 },
                    { label: 'Asia-FR', data: [22, 16, 16, 16], borderColor: '#27ae60', tension: 0.4, borderWidth: 2 },
                    { label: 'USHC-FR', data: [17, 0, 15.5, 21], borderColor: '#2980b9', tension: 0.4, borderWidth: 2 },
                    { label: 'SEACRM-FR', data: [12, 14, 15, 17], borderColor: '#16a085', tension: 0.4, borderWidth: 2 },
                    { label: 'I-FR', data: [10, 12, 15, 15], borderColor: '#8e44ad', tension: 0.4, borderWidth: 2 },
                    { label: 'Tata-FR', data: [11, 12, 13, 14], borderColor: '#e67e22', tension: 0.4, borderWidth: 2 },
                    { label: 'SGFR', data: [6.5, 7, 7, 7], borderColor: '#e91e63', tension: 0.4, borderWidth: 2 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Production Full Release Duration (Minutes)' },
                    legend: { position: 'right' }
                },
                scales: { y: { beginAtZero: true, max: 30 } }
            }
        });
    </script>
</body>
</html>
